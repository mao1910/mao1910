<!-- VISITOR BADGE -->
<!-- https://github.com/hehuapei/visitor-badge -->

<img align="right" src="https://visitor-badge.laobi.icu/badge?page_id=mao1910.mao1910&left_color=%2379DAF9&right_color=%23FE6E96" />


<!-- TYPING SVG -->
<!-- https://github.com/DenverCoder1/readme-typing-svg -->

<h1 align="center">
    <img src="https://readme-typing-svg.herokuapp.com/?font=Righteous&size=35&center=true&vCenter=true&width=500&height=70&color=FE6E96&font=poppins&duration=5000&lines=Hi+There!+üëã;+I'm+Mao!;" />
</h1>

<br/>

<!-- CODE/TERMINAL ABOUT ME -->
<h1 align="center">
<img src="./assets/terminal-5.gif" alt="Terminal" />
</h1>

<br/><br/><br/>


<!-- TECHNOLOGIES LOGOS -->
<!-- https://github.com/tandpfun/skill-icons -->

<h2 align="center">üíª Languages / Frameworks / Tools ‚öíÔ∏è</h2>
<div align="center">
    <img src="https://skillicons.dev/icons?i=javascript,typescript,angular,react,html,css,scss,bootstrap,cs,java,spring" />
    <img src="https://skillicons.dev/icons?i=flutter,firebase,supabase,mysql,git,github,gitlab,vscode,idea,maven,figma" />
</div>

<br/><br/><br/>


<!-- CONTRIBUTIONS SNAKE GAME -->
<!-- https://github.com/Platane/snk -->

<div align="center">
  <h2> My Contributionssssüêç </h2>
  <br>
  <img alt="contributions-eating Snake" src="https://raw.githubusercontent.com/mao1910/mao1910/output/github-contribution-grid-snake.svg" />

  <!-- Four lines below suggested by Planate for Dark mode-->
  <picture>
  <source media="(prefers-color-scheme: dark)" srcset="github-snake-dark.svg" />
  <source media="(prefers-color-scheme: light)" srcset="github-snake.svg" />
  </picture>
  
  <br/><br/><br/>
</div>


<!-- GITHUB STATS -->
<!-- https://github.com/DenverCoder1/github-readme-streak-stats -->
<!-- https://github.com/anuraghazra/github-readme-stats -->
<!-- https://github-readme-stats-mao1910.vercel.app/ My own Vercel deployment-->

<h2 align="center"> Statsüìù </h2>
  <br>
<div align=center>
  <img width=429 src="https://github-readme-stats-mao1910.vercel.app/api?username=mao1910&count_private=true&show_icons=true&theme=dracula&rank_icon=github&hide=contribs&border_radius=10&border_color=79DAF9" alt="github stats"/>
  <img width=396 src="https://streak-stats.demolab.com/?user=mao1910&count_private=true&theme=dracula&currStreakNum=79DAF9&currStreakLabel=FE6E96&border_radius=10&border=79DAF9" alt="streak stats"/>
  <br/>
  <img src="https://github-readme-stats-mao1910.vercel.app/api/top-langs/?username=mao1910&layout=compact&theme=dracula&border_radius=10&size_weight=0.5&count_weight=0.5&border_color=79DAF9" alt="languages stats" />
</div>

<br/><br/><br/>


<!-- FOOTER -->
<!-- https://github.com/DenverCoder1/readme-typing-svg -->
<!-- https://readme-typing-svg.demolab.com/demo/ -->

<a href="https://git.io/typing-svg"><img src="https://readme-typing-svg.demolab.com?font=Poppins&pause=1000&color=FE6E96&width=535&lines=Thanks+for+dropping+by!;Feel+free+to+check+any+of+the+Socials+below+%F0%9F%91%87;Or+the+Joke+Of+The+Day+if+you're+down+for+a+giggle+%F0%9F%98%9D;Hope+to+see+you+again+%F0%9F%91%8A;Uh%3F+You're+still+here%3F;Well...+I'm+running+out+of+things+to+say...;Tell+you+what%2C+due+to+your+effort+and+perseverance%2C;I+shall+present+you+with+a+short+poem%3A;%22To+code%2C+or+not+to+code%2C+that+is+the+question%3A;Whether+'tis+nobler+in+the+IDE+to+debug;The+errors+and+issues+of+outrageous+software%2C;Or+to+take+up+the+keyboard+against+a+sea+of+bugs;And+by+coding%2C+end+them.%22;by+William+Shakespeare%2C+probably.+;Pretty+sure+that's+Hamlet's.;Alrighty%2C+this+has+been+fun.;But+I'll+restart+the+loop+now...+see+ya+soon!" alt="Typing SVG" /></a>


<!--  SOCIAL NETWORKS -->
<!-- https://github.com/alexandresanlim/Badges4-README.md-Profile -->

  <div> 
    <a href="https://www.linkedin.com/" target="_blank"><img src="https://img.shields.io/badge/-LinkedIn-%230077B5?style=for-the-badge&logo=linkedin&logoColor=white" target="_blank"></a> <!-- ADD LINKEDIN PROFILE -->
    <a href = "https://www.google.com"><img src="https://img.shields.io/badge/Portfolio-4285F4?style=for-the-badge&logo=Google-chrome&logoColor=white" target="_blank"></a> <!-- ADD PORTFOLIO WEBSITE -->
    <a href="https://discord.gg" target="_blank"><img src="https://img.shields.io/badge/Discord-7289DA?style=for-the-badge&logo=discord&logoColor=white" target="_blank"></a> <!-- ADD DISCORD -->
    <a href = "mao1910dev@gmail.com"><img src="https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&logo=gmail&logoColor=white" target="_blank"></a>
  </div>


<!-- SPOTIFY PLAYING-->
<!-- https://github.com/novatorem/novatorem -->
<!-- https://spotify-now-playing-novatorem-git-main-mao1910.vercel.app/ My own Vercel deployment-->

[<img width=438px src="https://spotify-now-playing-git-main-mao1910.vercel.app//api/spotify/?border_color=FE6E96" alt="Mao Spotify Now Playing" />](https://open.spotify.com/user/31542et242zglhf42ydrtqgvuvde)


<!-- JOKE OF THE DAY -->
<!-- https://github.com/ABSphreak/readme-jokes -->
<!-- https://readme-jokes-git-master-mao1910.vercel.app/ My own Vercel deployment-->

<details>
<summary>I've got a Joke for you. Wanna hear it? üôà</summary>

<br/>

 <tr>
 <td style="padding-top:4px"><img src = "https://readme-jokes-git-master-mao1910.vercel.app/api?&theme=dracula"></td>
 </tr>

</details>


<!-- RSS FEED -->
<!-- https://github.com/gautamkrishnar/blog-post-workflow -->

<details>
<summary>üìï &nbsp;RSS feed</summary>

<br/>

<!-- BLOG-POST-LIST:START -->
 #### - [Bleeding-edge Project Using Everything New In Next.js 13üìö](https://dev.to/apestein/bleeding-edge-project-using-everything-new-in-nextjs-13-4mlg) 
 <details><summary>Article</summary> <p>Project using bleeding-edge stack. Drizzle ORM + Neon postgres + Clerk auth + Shadcn/ui + everything new in Next.js 13 (server components, server actions, streaming ui, parallel routes, intercepting routes). Fully edge runtime deployed. I wrote a breakdown and talked about some tricky / difficult things while building this project. This will be a good reference project for people looking to learn Next.js app router. Project uses 100% server actions and include features such as ability to search show catalog, SaaS subscription service with Stripe, optimistic update, and infinite scrolling.</p>

<p>Repo: <a href="https://github.com/Apestein/nextflix">https://github.com/Apestein/nextflix</a></p>

<p>Live: <a href="https://nextflix-blush.vercel.app/">https://nextflix-blush.vercel.app/</a></p>

 </details> 
 <hr /> 

 #### - [EKS and NetworkPolicies: the story so far](https://dev.to/aws-builders/eks-and-networkpolicies-the-story-so-far-3f45) 
 <details><summary>Article</summary> <p>On my monthly "let¬¥s keep up with AWS news" live stream, one of the news caught my eye as <strong>game changer</strong>, and it was this one:</p>

<ul>
<li>
<a href="https://aws.amazon.com/about-aws/whats-new/2023/08/amazon-vpc-cni-kubernetes-networkpolicy-enforcement/">Amazon VPC CNI now supports Kubernetes NetworkPolicy enforcement</a>~</li>
</ul>

<p>Let's have a peek on what this is about and why it is a game changer.</p>

<h2>
  
  
  Kubernetes NetworkPolicies
</h2>

<p><a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">NetworkPolicies</a> are often overlooked, but it is basically the major security feature of Kubernetes that grants you the hability to control the conectivity between your applications (and also the rest of the world!).</p>

<p>Many people get the feeling that the concept of <strong>namespaces</strong> provides isolation for applications running under, but it <strong>does not provide network isolation by default</strong>.</p>

<p>You can create a namespace <strong>app1</strong> and grant access for your <strong>Team A</strong> to deploy their applications. But if you allow <strong>Team B</strong> to run <strong>jobs</strong> on a namespace <strong>app2</strong>, even if they will not be able to modify app1 deployments, their jobs will be able to connect to the app1 deployments:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="c"># Checking IPs for the applications:</span>
<span class="nv">$ </span>kubectl get pods <span class="nt">-A</span> <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{range .items[*]}{.metadata.namespace}/{.metadata.name}: {.status.podIP}{"\n"}{end}'</span> |
fgrep app
app1/backend-84bf889f7f-nrxbr: 192.168.130.72
app1/frontend-54d8796d8c-2fzsk: 192.168.140.197
app2/job-f8dd4484b-kmxkm: 192.168.138.201

<span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>192.168.130.72 192.168.140.197<span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
    kubectl <span class="nt">-n</span> app2 <span class="nb">exec </span>job-f8dd4484b-kmxkm <span class="nt">--</span> curl <span class="nv">$i</span> <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s1">'%{HTTP_CODE}'</span> <span class="se">\</span>
  <span class="k">done
</span>200
200
</code></pre>

</div>



<p>This may not sound like a problem to you, but it is certainly not the most desireable situation, specially if most of your security is invested into the LoadBalancers/Web Application Firewalls that are outside the security perimeter of your cluster - it turns your cluster into a lateral movement extravaganza if someone not intended manages to get access to it.</p>

<h2>
  
  
  Securing the application
</h2>

<p>In order to block traffic from other namespaces to your application, you have to apply a <strong>NetworkPolicy</strong> that denies all incoming traffic:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: app1
spec:
  podSelector: {}
  policyTypes:
  - Ingress
'</span> | kubectl apply <span class="nt">-f</span> -
</code></pre>

</div>



<p>Syntax might look weird at a glance, but it applies to all pods (podSelector: {}) allowing <strong>nothing</strong> because there is no <strong>ingress</strong> block defined at the top level of spec.</p>

<p>After these rules get applied, no one will be able to access pods on namespace <strong>app1</strong>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="nv">$ </span><span class="k">for </span>i <span class="k">in </span>192.168.130.72 192.168.140.197<span class="p">;</span> <span class="k">do
    </span>kubectl <span class="nt">-n</span> app2 <span class="nb">exec </span>job-f8dd4484b-kmxkm <span class="nt">--</span> curl <span class="nt">--connect-timeout</span> 2 <span class="nv">$i</span> <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s1">'%{HTTP_CODE}\n'</span>
  <span class="k">done
</span>000
<span class="nb">command </span>terminated with <span class="nb">exit </span>code 28
000
<span class="nb">command </span>terminated with <span class="nb">exit </span>code 28
</code></pre>

</div>



<p>Problem is <strong>not even applications on app1 will be able to access each other</strong>. Once you apply any networkpolicy of a type (ingress or egress), all traffic that is not specificly allowed will be <strong>denied</strong>.</p>

<p>So if you have a frontend/backend combo like below:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>$ kubectl -n app1 get pods -o name
pod/backend-84bf889f7f-nrxbr
pod/frontend-54d8796d8c-2fzsk
</code></pre>

</div>



<p>You should allow incoming conections to backend only from the <strong>frontend</strong> deployment, and frontend might get its connections from a <strong>Load Balancer</strong> outside the cluster.</p>

<p>To allow frontend to access backend, one would leverage the <strong>kubernetes labels</strong> to make the rule <strong>dynamic</strong>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="nv">$ </span>kubectl <span class="nt">-n</span> app1 get pods <span class="nt">--show-labels</span> | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">' '</span> | <span class="nb">cut</span> <span class="nt">-f1</span>,6 <span class="nt">-d</span><span class="s1">' '</span>
NAME LABELS
backend-84bf889f7f-nrxbr <span class="nv">app</span><span class="o">=</span>backend,pod-template-hash<span class="o">=</span>84bf889f7f
frontend-54d8796d8c-2fzsk <span class="nv">app</span><span class="o">=</span>frontend,pod-template-hash<span class="o">=</span>54d8796d8c
</code></pre>

</div>



<p><strong>Backend</strong> pods will always have the label <strong>app=backend</strong>, and <strong>Frontend</strong> pods will have the label <strong>app=frontend</strong>; this will tell the NetworkPolicy Controller to update the rules every time a new pod is created (or destroyed).<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="c"># Conecting to the **service** backend from the pod frontend</span>
<span class="nv">$ </span>kubectl <span class="nt">-n</span> app1 <span class="nb">exec </span>deploy/frontend <span class="nt">--</span> curl <span class="nt">--connect-timeout</span> 2 <span class="nt">-so</span> /dev/null http://backend  <span class="nt">-w</span> <span class="s1">'%{http_code}'</span>
000
<span class="nb">command </span>terminated with <span class="nb">exit </span>code 28

<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-to-backend
  namespace: app1 
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: frontend
      ports:
        - protocol: TCP
          port: 80
'</span> | kubectl apply <span class="nt">-f</span> -

<span class="c"># Retesting:</span>
<span class="nv">$ </span> kubectl <span class="nt">-n</span> app1 <span class="nb">exec </span>deploy/frontend <span class="nt">--</span> curl <span class="nt">--connect-timeout</span> 2 <span class="nt">-so</span> /dev/null http://backend  <span class="nt">-w</span> <span class="s1">'%{http_code}'</span>
200
</code></pre>

</div>



<p>Unfortunately, there is no easy way to restrict access to the frontend pods from the load balancers, because they're not hosted inside the cluster. </p>

<p>(You can use <a href="https://docs.aws.amazon.com/eks/latest/userguide/security-groups-for-pods.html">Security Groups for Pods</a> for that!)</p>

<p>The best you can do is to limit connections from the subnets where the load balancers will create their ENIs (or use their ips, if you feel bold!):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: lb-to-frontend
  namespace: app1
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - ipBlock:
            cidr: 192.168.0.0/19
        - ipBlock:
            cidr: 192.168.32.0/19
        - ipBlock:
            cidr: 192.168.64.0/19
      ports:
        - protocol: TCP
          port: 80
'</span> | kubectl apply <span class="nt">-f</span> - 
</code></pre>

</div>



<p>Of course, anything else that is created on those subnets will be able to access the frontend pods on namespace app1.</p>

<p>The backend pod, otherwise, won't be able to start any connection to the frontend:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code><span class="nv">$ </span>k <span class="nt">-n</span> app1 <span class="nb">exec</span> <span class="nt">-it</span> deploy/backend <span class="nt">--</span> curl frontend:80 <span class="nt">-so</span> /dev/null <span class="nt">-w</span> <span class="s1">'%{http_code}'</span> <span class="nt">--connect-timeout</span> 2
000
</code></pre>

</div>



<p>Kubernetes NetworkPolicies allow an incredible degree of microsegmentation with little to no effort, even allowing for the devs themselves to be responsible to translate their integrations in a declarative way.</p>

<p>But of course, there is always a catch.</p>

<h2>
  
  
  NetworkPolicy Controller
</h2>

<p>Unfortunately, Netpols are one of the few native Kubernetes Resources that <strong>do not have a default controller assigned to it</strong> - the other major one would be <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingresses</a>.</p>

<p>Even though it's clearly stated in the docs, as quoted bellow:</p>

<blockquote>
<p>Network policies <strong>are implemented by the network plugin</strong>. To use network policies, <strong>you must be using a networking solution which supports NetworkPolicy</strong>. Creating a NetworkPolicy resource <strong>without a controller</strong> that implements it <strong>will have no effect</strong>.<br>
<a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/#prerequisites">source</a></p>
</blockquote>

<p>It's still easy for people miss it, specially if they are less kubernetes-savy than they should be when using this type of technology.</p>

<p>And yes, I've been asked before "why my netpols are not working" before. People just assume that it should work.</p>

<p>So, if you install an EKS cluster right now and reproduce the same configurations I have listed here, <strong>nothing will work</strong>.</p>

<p>At least for a while, because things changed!</p>

<h2>
  
  
  EKS and NetworkPolicies
</h2>

<p>Until August 2023, the only way use NetworkPolicies was to deploy a third party software called <a href="https://www.tigera.io/project-calico/">Project Calico</a>. It's a full fledged CNI, but one would enable only the Policy part as <a href="https://docs.aws.amazon.com/eks/latest/userguide/calico.html">described in the official EKS docs</a>.</p>

<p>But now, things changed! If you install a new EKS Cluster with the CNI version 1.14.0 or above, <a href="https://aws.amazon.com/about-aws/whats-new/2023/08/amazon-vpc-cni-kubernetes-networkpolicy-enforcement/">it now supports NetworkPolicies natively!</a>!</p>

<p>All you have to do is to create your EKS Cluster with the following on your eksctl yaml:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>...
addons:
- name: vpc-cni 
  version: 1.14.0
  configurationValues: |-
    enableNetworkPolicy: <span class="s2">"true"</span>    
  attachPolicyARNs:
  - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
...
</code></pre>

</div>



<p>And that's it! Awesome news for EKS users!</p>

<h2>
  
  
  Final notes
</h2>

<p>I believe it's worth noting that AWS CNI native NetworkPolicies make use of <a href="https://ebpf.io/"><strong>eBPF</strong></a> and not <strong>iptables</strong> as many of the other solutions available.</p>

<p>It does not support port translation from Services:</p>

<blockquote>
<p>For any of your Kubernetes services, the service port must be the same as the container port. If you're using named ports, use the same name in the service spec too.</p>
</blockquote>

<p>For a brief period during creation, the pod will not have any restrictions applied to it: </p>

<blockquote>
<p>The Amazon VPC CNI plugin for Kubernetes configures network policies for pods in parallel with the pod provisioning. Until all of the policies are configured for the new pod, containers in the new pod will start with a default allow policy. All ingress and egress traffic is allowed to and from the new pods unless they are resolved against the existing policies.</p>
</blockquote>

<p>It's also not supported on Fargate or Windows nodes. </p>

<h2>
  
  
  Links
</h2>

<ul>
<li><a href="https://aws.amazon.com/about-aws/whats-new/2023/08/amazon-vpc-cni-kubernetes-networkpolicy-enforcement/">https://aws.amazon.com/about-aws/whats-new/2023/08/amazon-vpc-cni-kubernetes-networkpolicy-enforcement/</a></li>
<li><a href="https://aws.amazon.com/blogs/containers/amazon-vpc-cni-now-supports-kubernetes-network-policies/">https://aws.amazon.com/blogs/containers/amazon-vpc-cni-now-supports-kubernetes-network-policies/</a></li>
</ul>

 </details> 
 <hr /> 

 #### - [Extens√µes do Visual Studio Code para um SRE](https://dev.to/laryssa/extensoes-do-visual-studio-code-para-um-sre-2nj5) 
 <details><summary>Article</summary> <p>Pe√ßo desculpas aos amantes do Neovim (se voc√™ est√° na bolha tech do Twitter, certamente lembrar√° do <a href="https://twitter.com/thayto_dev">Thayto</a> ao ler essa palavra), mas n√£o consigo largar o VS Code!</p>

<p>Algumas extens√µes, como Kubernetes, Terraform, Docker e afins, n√£o ser√£o citadas neste post. O intuito √© apresentar algumas extens√µes do editor de c√≥digo-fonte que facilitam meu trabalho di√°rio como Site Reliability Engineer.</p>

<ol>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=AmazonWebServices.aws-toolkit-vscode">AWS Toolkit</a></strong>: Se voc√™ trabalha com a AWS, essa extens√£o √© indispens√°vel. Com a utiliza√ß√£o do AWS SSO Login, ela se torna ainda mais poderosa. Caso n√£o tenha conhecimento e/ou n√£o saiba como configurar o AWS SSO Login, clique <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html">aqui</a> para mais informa√ß√µes.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=Infracost.infracost">Infracost</a></strong>:Esta extens√£o ajuda a estimar seus gastos com Terraform enquanto provisiona sua infraestrutura como c√≥digo.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=kennylong.kubernetes-yaml-formatter">Kubernetes YAML Formatter</a></strong>: Com esta extens√£o, seus arquivos .yaml do Terraform ter√£o a formata√ß√£o adequada.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=vscode-icons-team.vscode-icons">vscode-icons</a></strong>: Esta extens√£o √© universal e traz uma interface esteticamente mais harmoniosa para seus arquivos no VSCode, facilitando a identifica√ß√£o de arquivos e pastas.</p></li>
<li><p><a href="https://marketplace.visualstudio.com/items?itemName=run-at-scale.terraform-doc-snippets"><strong>Terraform doc snippets</strong></a>: Quem nunca precisou consultar a documenta√ß√£o do Terraform enquanto criava um recurso? Esta extens√£o traz as defini√ß√µes de maneira simplificada de diversos recursos do Terraform diretamente no editor.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=ms-python.vscode-pylance">Pylance</a></strong>: Esta extens√£o traz v√°rios facilitadores para o manuseio do Python, incluindo autocompletar, docstrings, esbo√ßo de c√≥digo e mais.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=eamodio.gitlens">GitLens</a></strong>: Embora seja chover no molhado, n√£o poderia deixar de mencionar o qu√£o poderoso √© usar o GitLens. Com ele, voc√™ pode visualizar informa√ß√µes de autoria das altera√ß√µes, linhas de c√≥digo modificadas, hist√≥rico de revis√£o de um arquivo, integra√ß√£o com o GitHub e muito mais.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=fabiospampinato.vscode-monokai-night">Monokai Night Theme</a></strong>: Como grande apreciadora do modo noturno e, ao mesmo tempo, de cores vibrantes, considero o modo noturno do Monokai um aliado poderoso para o descanso da vis√£o enquanto estou trabalhando na tela.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=aaron-bond.better-comments">Better Comments</a></strong>: Torna seus coment√°rios mais agrad√°veis esteticamente.</p></li>
<li><p><strong><a href="https://marketplace.visualstudio.com/items?itemName=VisualStudioExptTeam.vscodeintellicode">IntelliCode</a></strong>: Esta extens√£o utiliza IA para auxiliar no auto completar enquanto voc√™ escreve.</p></li>
</ol>

<p>Espero que voc√™ tenha descoberto ao menos uma nova extens√£o que vai facilitar o seu trabalho ao final desse texto. :)</p>

 </details> 
 <hr /> 

 #### - [Social bookmarks in the Fediverse](https://dev.to/andypiper/social-bookmarks-in-the-fediverse-5bki) 
 <details><summary>Article</summary> <p>Last week, there was a flurry of interest in a new addition to the <a href="https://en.wikipedia.org/wiki/Fediverse">#Fediverse</a>: <a href="https://techcrunch.com/2023/09/08/with-postmarks-social-bookmarking-is-back-but-this-time-its-built-on-the-fediverse/">Postmarks</a>. It's social bookmarking (like Digg, del.icio.us, or more recently, Pinboard), now with <a href="https://activitypub.rocks/">ActivityPub</a> support. Neat!</p>

<h3>
  
  
  Organising stuff, "back in the day"
</h3>

<p>Back in the 2000s I was a huge fan of a site called del.icio.us, and the original iteration of our weekly podcast - currently called <a href="https://gamesatwork.biz">Games at Work dot Biz</a> - was named Dogear Nation. Back when Michael and Michael kicked off that show, there was a podcast called Digg Nation which tried to round up the interesting community links and trends from the week on Digg. IBM at the time had an internal version of a social bookmarking / folksonomical platform similar to del.icio.us called "dogear" (like, folding the page of a book to mark it), so <a href="https://andypiper.co.uk/2009/01/05/co-hosting-dogear-nation-in-2009/">Dogear Nation encouraged listeners to tag links</a> on del.icio.us for us to discuss each week... del.icio.us was bought by Yahoo! in 2005, and eventually, went away.</p>

<p>Fast forward 15 years to our current podcast, and we still love it when listeners share links for us to discuss, but there's less of an organised way to do it!</p>

<h3>
  
  
  Join the Federation
</h3>

<p>Unlike the centralised "Web 2.0"-based, largely corporate-owned sites that dominate the current web, the Fediverse is a set of related services that share some common protocols (ActivityPub is one, but there are others involved) and are loosely-connected. As well as each service usually having some form of "flagship" instance, it is is also very common to encourage diversity by location and interests, and often self-hosting, so it won't be possible for <em>an unsavoury billionaire</em> to buy the things you use, or misuse and steal the data that you've put into them. Your network and your data are your own.</p>

<p>I'm very active across a range of sites and services that are analogous to those you might be familiar with. On Mastodon, for instance, I currently do some work with <a href="https://joinmastodon.org">Mastodon gGmbH</a>, the non-profit behind the project and host of two of the larger service instances; and although my original account was on one of those instances, at the end of last year I moved my account (taking the related network of connections with me) to a much smaller server run by a former coworker, mostly populated by other former coworkers, but I'm still connected with users across the rest of the Fediverse.</p>

<p>You can also find me on <a href="https://pixelfed.social/@andypiper">PixelFed</a> (Instagram-like photo sharing), on <a href="https://lemmy.world/u/andypiper">Lemmy</a> (Reddit-like groups and communities), on PeerTube (YouTube-like video channels) where <a href="https://diode.zone/@andypiper">I live on the diode.zone instance</a> for makers and electronics enthusiasts, on <a href="https://bookrastinating.com/@andypiper">Bookwyrm</a> (GoodReads-like community), and so on. Basically there are a number of "me" out there, in spaces where it makes sense. Essentially, if you're on Mastodon and you're interested in my videos, you can follow my PeerTube account from Mastodon without having to sign up for PeerTube. It's pretty cool.</p>

<blockquote>
<p>I strongly believe that federated services are the best opportunity for us to maintain a free and open Web.<br>
    - me, 2023</p>
</blockquote>

<h3>
  
  
  So, Postmarks?
</h3>

<p>Yes! Postmarks is a single-user, super small and simple server for managing your own bookmarks. When I add a bookmark <a href="https://pipesmarks.glitch.me">on my own Postmarks server</a>, my Postmarks account effectively publishes the new entry to the rest of the Fediverse as an activity. So, if you're interested in what I'm bookmarking and you have a Mastodon account, you can follow <code>@andypiper@pipesmarks.glitch.me</code> and you'll see the new entries as they get added. If you're not interested, don't follow my account, and we're all good. Oh, and it supports Atom feeds for different tags (categories), too.</p>

<p>Postmarks runs on <a href="https://glitch.com">Glitch</a> - or, anywhere else you can stand up a Node.js / Express app. Personally I love Glitch, and <a href="https://glitch.com/@andypiper">I've been using it for many years</a> now for hosting demos and trying out different projects - in fact, <a href="https://andypiper.me">my main links page</a> <a href="https://dev.to/andypiper/a-quick-glitch-bio-break-1c6a">runs on Glitch</a>. The Postmarks developer <a href="https://casey.kolderup.org/">Casey Kolderup</a> works there, and Casey has made it really straightforward to remix directly on Glitch, or <a href="https://github.com/ckolderup/postmarks">import from GitHub</a> there or to another service of your choice - it has very few dependencies.</p>

<h3>
  
  
  Getting involved
</h3>

<p>My usual pattern for reading and saving content is whilst mobile. There's a bookmarklet that's part of the project, but no easy way to add it to my system for links to end up on Postmarks from my phone or tablet. I turned to Apple Shortcuts to help out.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--W6WYdmPw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/nk6zruodxiyiptfps6x4.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--W6WYdmPw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/nk6zruodxiyiptfps6x4.png" alt="A screenshot of Apple Shortcuts on iPadOS 17 beta, showing the sequence of steps to send a link to Postmarks" width="800" height="1084"></a><br>
<em>A screenshot of Apple Shortcuts on iPadOS 17 beta, showing the sequence of steps to send a link to Postmarks</em></p>

<p>This does not do too much - it takes a link from the share sheet or clipboard, and opens the add bookmark page popup in a browser tab. At the moment<a href="https://github.com/ckolderup/postmarks/issues/61"> there's no full API for Postmarks</a>, so this is a bit of a stopgap or workaround. Annoyingly, it will also leave you with an empty browser tab you'll need to close, but it works.</p>

<p>If you'd like to try the automation, you can <a href="https://routinehub.co/shortcut/16547/">get it via RoutineHub</a>, which links to the Shortcut in iCloud. You'll be prompted to add the hostname of your Postmarks instance, and you will already need to have signed in to that site in your web browser of choice.</p>

<p>Beyond that, Glitch makes it easy to hack on features, because everything runs in the browser, including a code editor. So far I've been adding small features such as <a href="https://github.com/ckolderup/postmarks/pull/84">support for the nodeinfo endpoint used by other Fediverse servers</a>, and a slightly improved Atom feed. There's <a href="https://github.com/ckolderup/postmarks/issues?q=is%3Aissue+author%3Aandypiper+">lots I can think of to add</a>, but not so much time to play - this is giving me a chance to learn a bit more about ActivityPub internals, as well as "scratching an itch".</p>

<p>I'm also <a href="https://cerritos.glitch.me">playing with</a> another single-user ActivityPub server, <a href="https://shuttlecraft.net/">Shuttlecraft</a>, but that's a post for another day.</p>

 </details> 
 <hr /> 

 #### - [Exploring concurrent rate limiters, mutexes, semaphores](https://dev.to/shalvah/diving-into-concurrent-rate-limiters-mutexes-semaphores-42i6) 
 <details><summary>Article</summary> <p>This is a dump of my learnings and experiments while going down a little rabbit hole.</p>

<h1>
  
  
  Concurrent rate limiters
</h1>

<p>I was studying <a href="https://github.com/sidekiq/sidekiq/wiki/Ent-Rate-Limiting">Sidekiq's page on rate limiters</a>. The first type of rate limiting mentioned is the concurrent limiter: only <em>n</em> tasks are allowed to run at any point in time. Note that this is independent of time units (e.g. per second), or how long they take to run. The only limitation is the number of concurrent tasks/requests.</p>

<p>So I asked myself, how would I implement a concurrent rate limiter? I'm fairly familiar with locking (via Redis and the database, for instance), so that was what came to mind, but in its usual form, that only works as a mutex (number of allowed tasks, <em>n</em> = 1). I wasn't sure about how to implement that when <em>n</em> &gt; 1. Decided to dig into it from first principles.</p>

<h2>
  
  
  Concurrency control scenarios
</h2>

<p>In this case, that meant stepping back to think about concurrency control in general, and the scenarios I know of.</p>

<p>The first scenario is <strong>process-local</strong>: you have multiple threads within a process, and you want to ensure only <em>n</em> threads can access a resource at once. I already knew how to do this:</p>

<ul>
<li>when <em>n</em> = 1, use a <a href="https://vaneyckt.io/posts/ruby_concurrency_in_praise_of_the_mutex/">mutex</a>. Only the thread with the lock on the mutex can execute; others have to wait.</li>
<li>when <em>n</em> &gt; 1, use a <a href="https://en.wikipedia.org/wiki/Semaphore_(programming)">semaphore</a>. I wasn't too familiar with semaphores, so I decided to brush up.</li>
</ul>

<p>Semaphores are similar to mutexes, but they are less about guaranteeing exclusive access and more about keeping track of who has access. A semaphore starts out with a fixed number of "permits". A thread can request a permit (similar to acquiring a lock), and that reduces the number of available permits. When all permits are in use, any requesting threads will have to wait until one is released. In this sense, a semaphore is kinda like a bouncer at a club‚Äîit regulates the number of people who can get in.</p>

<h3>
  
  
  Semaphores via mutexes
</h3>

<p>There are many semaphore implementations available for Ruby. I decided to implement one myself. The key thing is that the semaphore governs access to a resource (the number of permits), so we need a way to ensure the semaphore can do this job safely. I used Ruby's native Mutex to achieve this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Semaphore</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">max_permits</span><span class="p">)</span>
    <span class="vi">@max_permits</span> <span class="o">=</span> <span class="n">max_permits</span>
    <span class="vi">@used_permits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="vi">@mutex</span> <span class="o">=</span> <span class="no">Mutex</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">permit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">acquire</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
    <span class="n">release</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">acquire</span>
    <span class="n">acquired</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="k">until</span> <span class="n">acquired</span>
      <span class="vi">@mutex</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
        <span class="n">acquired</span> <span class="o">=</span> <span class="n">permit_acquired?</span>
      <span class="k">end</span>

      <span class="nb">sleep</span> <span class="mf">0.05</span> <span class="k">unless</span> <span class="n">acquired</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">permit_acquired?</span>
    <span class="k">if</span> <span class="vi">@used_permits</span> <span class="o">&lt;</span> <span class="vi">@max_permits</span>
      <span class="vi">@used_permits</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">release</span>
    <span class="vi">@mutex</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
      <span class="vi">@used_permits</span> <span class="o">-=</span> <span class="mi">1</span> <span class="k">if</span> <span class="vi">@used_permits</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">end</span>

    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@max_permits</span> <span class="o">-</span> <span class="vi">@used_permits</span><span class="si">}</span><span class="s2"> permit(s) available"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

</div>



<p>Usage:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="n">semaphore</span> <span class="o">=</span> <span class="no">Semaphore</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">semaphore</span><span class="p">.</span><span class="nf">permit</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'Thread 1 acquired semaphore'</span>
    <span class="nb">sleep</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">p</span> <span class="s2">"Thread 1 releasing"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">t2</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">semaphore</span><span class="p">.</span><span class="nf">permit</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'Thread 2 acquired semaphore'</span>
    <span class="nb">sleep</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">p</span> <span class="s2">"Thread 2 releasing"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">t3</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">semaphore</span><span class="p">.</span><span class="nf">permit</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'Thread 3 acquired semaphore'</span>
    <span class="nb">sleep</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">p</span> <span class="s2">"Thread 3 releasing"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t3</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:join</span><span class="p">)</span>
</code></pre>

</div>



<p>Sample output:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>Thread 1 acquired semaphore
Thread 2 acquired semaphore
"Thread 2 releasing"
1 permit(s) available
Thread 3 acquired semaphore
"Thread 1 releasing"
1 permit(s) available
"Thread 3 releasing"
2 permit(s) available
</code></pre>

</div>



<p>This approach checks whether there are any available permits and returns one if so. Otherwise, it will sleep for 0.05 seconds and check again. The mutex guarantees that we can safely increment or decrement the number of permits without race conditions. This is a basic implementation, btw; one important thing missing is wait timeouts‚Äîwe shouldn't have to wait forever.</p>

<p>Also note that there is no expiry on a permit‚Äîa client could get a permit and refuse to release it! Apparently, that's by design; semaphores don't control what you do with the permit. The onus is on you to be responsible with it.</p>

<h3>
  
  
  Fair semaphores
</h3>

<p>This approach suffers from <em>unfairness</em>. Suppose thread A has been waiting for a permit to become available, and finally, another thread releases one. If at that moment, thread A is still sleeping, and a new thread (thread B) is launched, B might acquire the permit instead of A. In essence, an unlucky thread could wait for a very long time (or forever!) while newer threads get a permit. This is like if the bouncer selected people at random, instead of who's been waiting the longest.</p>

<p>Also, the constant sleeping and waking up (polling) is suboptimal. We're giving the Ruby interpreter and OS more work to do (constantly scheduling and waking up the thread) when there might not be actually any permits available, and we're potentially taking time away from threads which have actual work to do.</p>

<p>So I decided to try a different approach, using Ruby's <code>Thread::Queue</code>. <code>Thread::Queue</code> is a queue data structure designed for concurrent use; requesting an item (via <code>#pop</code>) will either return an item if one is available, or block until another thread adds one to the queue (via <code>#push</code>). So we model the list of permits as a queue (you can put anything you want in the queue, as long as it's the same number as the permits). Acquiring = popping, releasing = pushing.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Semaphore</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">max_permits</span><span class="p">)</span>
    <span class="vi">@permits</span> <span class="o">=</span> <span class="no">Thread</span><span class="o">::</span><span class="no">Queue</span><span class="p">.</span><span class="nf">new</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_permits</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">permit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">acquire</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
    <span class="n">release</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">acquire</span>
    <span class="vi">@permits</span><span class="p">.</span><span class="nf">pop</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">release</span>
    <span class="vi">@permits</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@permits</span><span class="p">.</span><span class="nf">size</span><span class="si">}</span><span class="s2"> permit(s) available"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

</div>



<p>This works too (and the code is also much shorter). I'm not a 100% certain the waiting threads are served in order of who asked first (the docs don't say exactly that), but I think that's the case.</p>

<h3>
  
  
  Condition variables
</h3>

<p>After this, I took a look at the semaphore class in the popular library, <a href="https://github.com/ruby-concurrency/concurrent-ruby/">concurrent-ruby</a> to see how they implement it, and I learnt about something new: <a href="https://vaneyckt.io/posts/ruby_concurrency_in_praise_of_condition_variables/">condition variables</a>. And Ruby comes with this included!</p>

<p>The name sounds super technical, but it's quite approachable in reality: a condition variable lets you tell other threads waiting on a resource that it's now available. It's meant to be used with a mutex. Instead of having the thread constantly poll, as in my initial implementation, the thread sleeps forever (or with a timeout), and gets woken up by the condition variable when a new permit is available. Here's the new implementation:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Semaphore</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">max_permits</span><span class="p">)</span>
    <span class="vi">@max_permits</span> <span class="o">=</span> <span class="n">max_permits</span>
    <span class="vi">@used_permits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="vi">@mutex</span> <span class="o">=</span> <span class="no">Mutex</span><span class="p">.</span><span class="nf">new</span>
    <span class="vi">@condition_variable</span> <span class="o">=</span> <span class="no">ConditionVariable</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">permit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">acquire</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
    <span class="n">release</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">acquire</span>
    <span class="vi">@mutex</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
      <span class="k">until</span> <span class="n">permit_acquired?</span>
        <span class="vi">@condition_variable</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="vi">@mutex</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">permit_acquired?</span>
    <span class="k">if</span> <span class="vi">@used_permits</span> <span class="o">&lt;</span> <span class="vi">@max_permits</span>
      <span class="vi">@used_permits</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">release</span>
    <span class="vi">@mutex</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
      <span class="vi">@used_permits</span> <span class="o">-=</span> <span class="mi">1</span> <span class="k">if</span> <span class="vi">@used_permits</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">end</span>
    <span class="vi">@condition_variable</span><span class="p">.</span><span class="nf">signal</span>

    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@max_permits</span> <span class="o">-</span> <span class="vi">@used_permits</span><span class="si">}</span><span class="s2"> permit(s) available"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

</div>



<p>Rather than polling (sleep-wake-check-sleep), we just sleep (<code>@condition_variable.wait</code>), and then when another thread is done, they call <code>@condition_variable.signal</code>, which will wake up <em>the first</em> waiting thread (so it's fair, yay). It reminds me a bit of events in JavaScript.</p>

<h2>
  
  
  Distributed concurrency control
</h2>

<p>Okay, good diversion; now, back to concurrent scenarios. We've looked at process-local scenarios. The second scenario is <strong>system-local</strong>, but separate processes. This is, for example, when you have multiple web server processes running on the same machine, and you want to control access to a shared resource.</p>

<p>Processes don't share memory, so our mutex/semaphore can't live inside any single process. We have to use an external datastore, such as a cache (eg Redis), or a database (PostgreSQL). You could even use a file or what-have-you.</p>

<p>A third scenario is in a <strong>distributed system</strong>: the processes are on separate machines. This is an extension of the above case, so the same approaches as above apply, but obviously in a distributed way (the datastore has to live on an external location all the processes can access).</p>

<p>Okay, so how could we implement mutexes (<em>n</em> = 1) here?</p>

<h3>
  
  
  Aside: things to keep in mind
</h3>

<p>When dealing with locks, you want to avoid <em>starvation</em> (ie, an unruly/crashed client holding on to the lock and blocking everyone else). A common (but imperfect) way to avoid this is to set a <em>lock expiry</em> (how long a given client can hold a lock). This way, if a client is unable to release the lock (for instance, if they crashed), it will automatically be released after a while.</p>

<p>You also want to limit <em>contention</em>, typically by setting a <em>wait timeout</em> (how long a client should wait for when another client is using the lock). If you don't set a wait timeout, you could end up with other processes hanging forever because a lock is in use. Sometimes that might be desired, but more likely you probably want to quit and try again later. Either way, you should decide on your wait timeout policy for your clients.</p>

<h3>
  
  
  Mutex with Redis
</h3>

<p>A common pattern is to set a key in Redis, something like <code>SET some-lock-key some-value NX EX expiry-in-seconds</code>.</p>

<ul>
<li>
<code>NX</code> will set the key only if it doesn't already exists. If the key already exists, it means another process has the lock, and you need to retry.</li>
<li>
<code>EX</code> (or <code>PX</code>) sets a time when the lock expires, so a crashed process doesn't keep on hanging on to the lock</li>
<li>To release the lock, you can use <code>DEL</code> to delete the key. (But you shouldn't! See below.)</li>
</ul>

<p>This works, but has a few flaws:</p>

<ul>
<li>Processes need to poll Redis until they get the lock, or give up. We already saw why polling is suboptimal.</li>
<li>Lock expiry is, at best, a guess. You're <em>hoping</em> all your clients will finish in that time. But if one process somehow doesn't finish in time, the lock would erroneously expire, and you could end up with two concurrent processes (!)</li>
<li>If the above happens, and the first process tries to release the lock with <code>DEL</code>, it would delete the lock now held by the second process. The Redis docs have <a href="https://redis.io/docs/manual/patterns/distributed-locks/#:~:text=Correct%20Implementation%20with%20a%20Single%20Instance">details</a> on how to correctly delete a lock.</li>
<li>In a distributed Redis cluster, a lock could be acquired multiple times. Distributed locking is probably a topic for another day, though. Patterns like <a href="https://redis.io/docs/manual/patterns/distributed-locks/">Redlock</a> are suggested (but also <a href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">criticized</a>).</li>
</ul>

<h3>
  
  
  Mutex with PostgreSQL
</h3>

<p>For SQL, I like <a href="https://shiroyasha.io/advisory-locks-and-how-to-use-them.html">Postgres' advisory locks</a>. Running <code>SELECT pg_advisory_lock(123)</code> will give this client a lock called <code>123</code>, and all other clients who run that same statement will have to wait until the first client releases the lock.</p>

<p>With Postgres' advisory locks, you don't need a lock expiry, since the lock is bound to the session or transaction. If the client crashes, PG will release the lock. Wait timeouts aren't directly supported, but you can achieve this by using <a href="https://postgresqlco.nf/doc/en/param/lock_timeout/">the <code>lock_timeout</code> setting</a> (combined with transaction-level locks if you don't want global wait timeouts):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">BEGIN</span><span class="p">;</span> <span class="c1">-- Start transaction</span>
<span class="k">SET</span> <span class="k">LOCAL</span> <span class="n">lock_timeout</span> <span class="o">=</span> <span class="s1">'10s'</span><span class="p">;</span> <span class="c1">-- Error if no lock acquired after 10s</span>
<span class="k">SELECT</span> <span class="n">pg_advisory_xact_lock</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span> <span class="c1">-- Get a transaction-level lock</span>

<span class="c1">-- Execute the rest of your code</span>

<span class="k">COMMIT</span><span class="p">;</span> <span class="c1">-- End transaction; lock is released automatically</span>
</code></pre>

</div>



<p>MySQL also has advisory locks (although they are not transaction-bound) and wait timeouts:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">SELECT</span> <span class="n">GET_LOCK</span><span class="p">(</span><span class="s1">'my_lock'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">-- Error if no lock acquired after 10s</span>
<span class="k">SELECT</span> <span class="n">RELEASE_LOCK</span><span class="p">(</span><span class="s1">'my_lock'</span><span class="p">);</span>
</code></pre>

</div>



<p>I love Redis, but I think I prefer SQL databases for mutexes. Since the Redis API does not expose any concept of a lock, we try to emulate it with the <code>SET NX</code> pattern or more complicated algorithms, which is why we have to do the "lock expiry" dance. PostgreSQL, on the other hand, has locks as a first-class function, which means it can provide better guarantees, such as the fact that locks will always be released when the session ends.</p>

<h2>
  
  
  Semaphore with Redis
</h2>

<p>How about semaphores (<em>n</em> &gt; 1)? At first I was thinking of something using <a href="https://redis.io/docs/interact/transactions/">Redis transactions</a> (<code>MULTI</code>) and <code>WATCH</code>, something like this (not valid code):<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight ruby"><code><span class="no">WATCH</span> <span class="n">semaphore</span><span class="o">-</span><span class="n">permits</span><span class="o">-</span><span class="n">used</span>
<span class="n">max</span> <span class="o">=</span> <span class="no">GET</span> <span class="n">semaphore</span><span class="o">-</span><span class="n">permits</span><span class="o">-</span><span class="n">max</span>
<span class="n">used</span> <span class="o">=</span> <span class="no">GET</span> <span class="n">semaphore</span><span class="o">-</span><span class="n">permits</span><span class="o">-</span><span class="n">used</span>
<span class="k">return</span> <span class="k">unless</span> <span class="n">used</span> <span class="o">&lt;</span> <span class="n">max</span> <span class="c1"># No permits available</span>

<span class="no">MULTI</span>
<span class="no">INCR</span> <span class="n">semaphore</span><span class="o">-</span><span class="n">permits</span><span class="o">-</span><span class="n">used</span>
<span class="no">EXEC</span>
</code></pre>

</div>



<p><code>WATCH</code> will fail the transaction if the <code>semaphore-permits-used</code> is modified by another client, so this serves as a mutex for the permits. But this implementation seems pretty complex to me; it involves us switching between our app code and Redis multiple times (or making this a Redis script). i haven't had the chance to try it yet, though.</p>

<p>Turns out, you can implement a semaphore in Redis quite simply with blocking list operations (akin to what we did with <code>Thread::Queue</code> in Ruby):</p>

<ul>
<li>First, put <em>n</em> items in a list in Redis (say <code>semaphore-available-permits</code>)</li>
<li>To acquire a permit, call <code>BLPOP semaphore-available-permits</code>. This will pop one item from the list. If there's none available, it will block until some other client pushes one. You can also specify a wait timeout: <code>BLPOP semaphore-available-permits &lt;wait-timeout&gt;</code>.</li>
<li>To release a permit, call <code>RPUSH semaphore-available-permits</code>. If there are clients waiting for a permit, the longest waiting client will automatically get the newly released permit (so it's a fair semaphore).</li>
</ul>

<p>It's still a bit ugly, because that first step is crucial (otherwise clients would wait forever). The best approach there is to either have each client check if the semaphore has been initialized (e.g. by checking if a certain key exists), and initialize it themselves if not; alternatively, you could have an explicit initialization step that creates the permits when your app starts up.</p>

<h2>
  
  
  Semaphore with Postgres
</h2>

<p>Unfortunately, advisory locks don't help here. We need a good ol' database table to keep track of our semaphores.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">global_semaphores</span> <span class="p">(</span>
  <span class="n">semaphore_name</span> <span class="nb">TEXT</span><span class="p">,</span>
  <span class="n">max_permits</span> <span class="nb">INTEGER</span><span class="p">,</span>
  <span class="n">used_permits</span> <span class="nb">INTEGER</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</code></pre>

</div>



<p>To kick things off, we create the semaphore with capacity <em>n</em> = 4:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">global_semaphores</span> <span class="p">(</span><span class="nv">"my_semaphore"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre>

</div>



<p>Checking out and releasing a permit is straightforward: update the <code>used_permits</code> count. But, to ensure exclusive access, we must use a transaction:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">UPDATE</span> <span class="n">global_semaphores</span> 
  <span class="k">SET</span> <span class="n">used_permits</span> <span class="o">=</span> <span class="n">used_permits</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">WHERE</span> <span class="n">semaphore_name</span> <span class="o">=</span> <span class="nv">"my_semaphore"</span>
  <span class="k">AND</span> <span class="n">used_permits</span> <span class="o">&lt;</span> <span class="n">max_permits</span><span class="p">;</span>
</code></pre>

</div>



<p>The <code>UPDATE</code> statement will automatically lock the matching row (our semaphore) until it finishes executing, so no transaction needed (unless we want to specify a local timeout). All we need to do is check if the row was updated; if so, we have our permit.</p>

<p>To release the permit, it's the reverse:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight sql"><code><span class="k">UPDATE</span> <span class="n">global_semaphores</span> 
  <span class="k">SET</span> <span class="n">used_permits</span> <span class="o">=</span> <span class="n">used_permits</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="k">WHERE</span> <span class="n">semaphore_name</span> <span class="o">=</span> <span class="nv">"my_semaphore"</span><span class="p">;</span>
</code></pre>

</div>



<p>One downside here is that there's no easy way to block while waiting for a new permit to be available. We'll have to rely on polling.</p>

<p>I find it quite interesting the differences in approach between Redis and PG here: an explicit list of permit items (Redis) vs a counter (Postgres). I think you could use either approach in both, but it would be more complicated. (I actually had an initial implementation in Postgres that used multiple rows and transactional isolation, but it was def more complex.) Postgres' transactional guarantees make it easier to work with a single counter (= a single row), while Redis' list data structure and blocking options make that approach straightforward.</p>

<h1>
  
  
  Putting it all together: concurrent rate limiter
</h1>

<p>We're almost there! Actually, we're there. A concurrent rate limiter is essentially a semaphore. The max number of permits = the max number of concurrent tasks.</p>

<p>However, the Sidekiq version also includes lock expiry, so I spent some time thinking about it. My conclusion: there's no "nice" way to do it. The permit expiry approach I could think of (or find in the wild) was:</p>

<ul>
<li>When a client gets a permit successfully, it must record that permit and its acquisition time (in a hash in Redis, or a row in a table in Postgres)</li>
<li>When the client releases the permit, it can then delete the hash entry or row</li>
<li>You either have an external process that regularly checks for permits that are too old and force-releases them, or have a newly-connecting client do that check themselves.</li>
</ul>

<p>I think that's it for that exploration. It was quite interesting racking my brain about semaphores and guarantees. My current conclusions are that I'd prefer to use Postgres for mutexes and Redis for semaphores. It was also a revelation that semaphores don't provide any guarantee of expiry, so you must program carefully around that.</p>

 </details> 
 <hr /> 
<!-- BLOG-POST-LIST:END -->
</table>
</details>


<!-- TODO
Change the 3stats boxes around, possibly two on top and one on bottom
Fix RSSfeed
Fix Spotify Playlists
Fix Socials [Portfolio, Discord, Linkedin]
In the future, add Public Repositories of Selected Projects
-->
