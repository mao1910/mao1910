<!-- TODO 
Update Socials
Update "Technologies"
Update Terminal
Update Top Languages (exclude forked repositories)
Update Blog Feed (daily.dev bookmarks)
-->

<!-- VISITOR BADGE -->
<!-- https://github.com/hehuapei/visitor-badge -->

<img align="right" src="https://visitor-badge.laobi.icu/badge?page_id=mao1910.mao1910&left_color=%2379DAF9&right_color=%23FE6E96" />


<!-- TYPING SVG -->
<!-- https://github.com/DenverCoder1/readme-typing-svg -->

<h1 align="center">
    <img src="https://readme-typing-svg.herokuapp.com/?font=Righteous&size=35&center=true&vCenter=true&width=500&height=70&color=FE6E96&font=poppins&duration=5000&lines=Hi+There!+üëã;+I'm+Mao!;" />
</h1>

<br/>


<!-- ABOUT ME TERMINAL -->
<div align="center">
<img src="/assets/terminal-8.gif?raw=true" alt="Terminal"/>
</div>
<br/><br/><br/>


<!-- TECHNOLOGIES LOGOS -->
<!-- https://github.com/tandpfun/skill-icons -->

<h2 align="center">üíª Languages / Frameworks / Tools ‚öíÔ∏è</h2>
<div align="center">
    <img src="https://skillicons.dev/icons?i=javascript,typescript,angular,react,html,css,scss,bootstrap,cs,java,spring" />
    <img src="https://skillicons.dev/icons?i=flutter,firebase,supabase,mysql,git,github,gitlab,vscode,idea,maven,figma" />
</div>

<br/><br/><br/>


<!-- CONTRIBUTIONS SNAKE GAME -->
<!-- https://github.com/Platane/snk -->

<div align="center">
  <h2> My Contributionssssüêç </h2>
  <br>
  <img alt="contributions-eating Snake" src="https://raw.githubusercontent.com/mao1910/mao1910/output/github-contribution-grid-snake.svg" />

  <!-- Four lines below suggested by Planate for Dark mode-->
  <picture>
  <source media="(prefers-color-scheme: dark)" srcset="github-snake-dark.svg" />
  <source media="(prefers-color-scheme: light)" srcset="github-snake.svg" />
  </picture>
  
  <br/><br/><br/>
</div>


<!-- GITHUB STATS -->
<!-- https://github.com/DenverCoder1/github-readme-streak-stats --> <!--  My Vercel -->
<!-- https://github.com/anuraghazra/github-readme-stats --> <!--  My  Vercel -->

<h2 align="center"> Statsüìù </h2>
  <br>
<div align=center>
  <img width=429 src="https://github-readme-stats-mao1910.vercel.app/api?username=mao1910&count_private=true&show_icons=true&theme=dracula&rank_icon=github&hide=contribs&border_radius=10&border_color=79DAF9" alt="github stats"/>
  <img width=396 src="https://github-readme-streak-stats-2235.vercel.app?user=mao1910&count_private=true&theme=dracula&currStreakNum=79DAF9&currStreakLabel=FE6E96&border_radius=10&border=79DAF9" alt="streak stats"/>
  <br/>
  <img src="https://github-readme-stats-mao1910.vercel.app/api/top-langs/?username=mao1910&layout=compact&theme=dracula&border_radius=10&size_weight=0.5&count_weight=0.5&border_color=79DAF9" alt="languages stats" />
</div>

<br/><br/><br/>


<!-- FOOTER -->
<!-- https://github.com/DenverCoder1/readme-typing-svg -->
<!-- https://readme-typing-svg.demolab.com/demo/ -->

<a href="https://git.io/typing-svg"><img src="https://readme-typing-svg.demolab.com?font=Poppins&pause=1000&color=FE6E96&width=535&lines=Thanks+for+dropping+by!;Feel+free+to+check+any+of+the+Socials+below+%F0%9F%91%87;Or+the+Joke+Of+The+Day+if+you're+down+for+a+giggle+%F0%9F%98%9D;Hope+to+see+you+again+%F0%9F%91%8A;Uh%3F+You're+still+here%3F;Well...+I'm+running+out+of+things+to+say...;Tell+you+what%2C+due+to+your+effort+and+perseverance%2C;I+shall+present+you+with+a+short+poem%3A;%22To+code%2C+or+not+to+code%2C+that+is+the+question%3A;Whether+'tis+nobler+in+the+IDE+to+debug;The+errors+and+issues+of+outrageous+software%2C;Or+to+take+up+the+keyboard+against+a+sea+of+bugs;And+by+coding%2C+end+them.%22;by+William+Shakespeare%2C+probably.+;Pretty+sure+that's+Hamlet's.;Alrighty%2C+this+has+been+fun.;But+I'll+restart+the+loop+now...+see+ya+soon!" alt="Typing SVG" /></a>


<!--  SOCIAL NETWORKS -->
<!-- https://github.com/alexandresanlim/Badges4-README.md-Profile -->

  <div> 
    <a href="https://www.deviantart.com/madeinkobaia/art/my-profile-is-under-construction-265626465" target="_blank"><img src="https://img.shields.io/badge/-LinkedIn-%230077B5?style=for-the-badge&logo=linkedin&logoColor=white" target="_blank"></a> <!-- ADD LINKEDIN PROFILE -->
    <a href = "https://www.nicepng.com/ourpic/u2q8o0t4t4r5o0r5_website-under-construction-png-graphic-transparent-website-under/"><img src="https://img.shields.io/badge/Portfolio-4285F4?style=for-the-badge&logo=Google-chrome&logoColor=white" target="_blank"></a> <!-- ADD PORTFOLIO WEBSITE -->
    <a href="https://discord.gg" target="_blank"><img src="https://img.shields.io/badge/Discord-7289DA?style=for-the-badge&logo=discord&logoColor=white" target="_blank"></a> <!-- ADD DISCORD --> <!-- User or Server? -->
    <a href = "mailto:mao1910dev@gmail.com"><img src="https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&logo=gmail&logoColor=white" target="_blank"></a>
  </div>


<!-- SPOTIFY PLAYING-->
<!-- https://github.com/novatorem/novatorem --> <!-- My Vercel -->

[<img width=438px src="https://spotify-now-playing-git-main-mao1910.vercel.app//api/spotify/?border_color=FE6E96" alt="Mao Spotify Now Playing" />](https://open.spotify.com/user/31542et242zglhf42ydrtqgvuvde)


<!-- JOKE OF THE DAY -->
<!-- https://github.com/ABSphreak/readme-jokes --> <!-- My Vercel -->

<details>
<summary>I've got a Joke for you. Wanna hear it? üôà</summary>

<br/>

 <tr>
 <td style="padding-top:4px"><img src = "https://readme-jokes-git-master-mao1910.vercel.app/api?&theme=dracula"></td>
 </tr>

</details>


<!-- RSS FEED -->
<!-- https://github.com/gautamkrishnar/blog-post-workflow -->

<details>
<summary>üìï &nbsp;RSS feed</summary>

<br/>


<!-- BLOG-POST-LIST:START -->
 #### - [Template Method com composi√ß√£o](https://dev.to/hugaomarques/template-method-com-composicao-33cg) 
 <details><summary>Article</summary> <p>Eu acho que esse vai ser curto, vamos l√°! Hoje mais cedo eu fiz o seguinte coment√°rio sobre heran√ßa no finado Twitter.</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--SVknwoJd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1x1a8e8081ofzx2fx1p3.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--SVknwoJd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1x1a8e8081ofzx2fx1p3.png" alt="Image description" width="601" height="202"></a></p>

<p>Imediatamente, surgiram alguns coment√°rios interessantes, mas um dele me chamou a aten√ß√£o. O amigo @DevCorinthiano777 perguntou:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--nBFEzA0n--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/41qi62r3k6u5jrpk8o7m.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--nBFEzA0n--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/41qi62r3k6u5jrpk8o7m.png" alt="Image description" width="623" height="155"></a></p>

<p>E com isso, automaticamente as engrenagens internas aqui na minha cabe√ßa come√ßaram a funcionar ü§î.</p>

<h2>
  
  
  Mas o que danado √© um Template Method?
</h2>

<p>Sendo super sucinto, o Template Method √© um "design pattern" (ou padr√£o de projeto em PT-br), que define uma "receita de bolo". Essa receita √© definida na super-classe e a partir da√≠ as classes filhas podem implementar passos espec√≠ficos dessa "receita". Isso fica mais claro no exemplo abaixo:</p>

<p>Disclaimer: Eu sou um dev cansado, usei o gepeto pra me ajudar a escrever o exemplo r√°pido.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight java"><code><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ReviewTemplate</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">reviewText</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReviewTemplate</span><span class="o">(</span><span class="nc">String</span> <span class="n">reviewText</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">reviewText</span> <span class="o">=</span> <span class="n">reviewText</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// M√©todo de template que orquestra o processo de valida√ß√£o e salvamento</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">validateReview</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">saveReview</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Revis√£o salva com sucesso."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A revis√£o n√£o √© v√°lida e n√£o foi salva."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// M√©todo abstrato que deve ser implementado pelas subclasses para a valida√ß√£o</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">validateReview</span><span class="o">();</span>

    <span class="c1">// M√©todo comum para salvar a revis√£o (implementa√ß√£o padr√£o)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">saveReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Revis√£o salva no banco de dados: "</span> <span class="o">+</span> <span class="n">reviewText</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CriarReview</span> <span class="kd">extends</span> <span class="nc">ReviewTemplate</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">CriarReview</span><span class="o">(</span><span class="nc">String</span> <span class="n">reviewText</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">reviewText</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Implementa√ß√£o espec√≠fica de valida√ß√£o para criar uma revis√£o</span>
        <span class="k">return</span> <span class="n">reviewText</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reviewText</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">AtualizarReview</span> <span class="kd">extends</span> <span class="nc">ReviewTemplate</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">AtualizarReview</span><span class="o">(</span><span class="nc">String</span> <span class="n">reviewText</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">reviewText</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Implementa√ß√£o espec√≠fica de valida√ß√£o para atualizar uma revis√£o</span>
        <span class="k">return</span> <span class="n">reviewText</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reviewText</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Criar uma nova revis√£o</span>
        <span class="nc">ReviewTemplate</span> <span class="n">criarReview</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CriarReview</span><span class="o">(</span><span class="s">"Esta √© uma √≥tima revis√£o."</span><span class="o">);</span>
        <span class="n">criarReview</span><span class="o">.</span><span class="na">processReview</span><span class="o">();</span>

        <span class="c1">// Atualizar uma revis√£o existente</span>
        <span class="nc">ReviewTemplate</span> <span class="n">atualizarReview</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtualizarReview</span><span class="o">(</span><span class="s">"Vers√£o atualizada da revis√£o."</span><span class="o">);</span>
        <span class="n">atualizarReview</span><span class="o">.</span><span class="na">processReview</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>

</div>



<p>Observe como o review template define um padr√£o de como todas as suas filhas s√£o tratadas. A partir da√≠ as classes filhas s√≥ seguem esse padr√£o, implementando peda√ßos do algoritmo e expondo apenas o m√©todo p√∫blico <code>processReview()</code></p>

<h2>
  
  
  Entendi, mas se a implementa√ß√£o usa heran√ßa, como tu vai fazer pra usar composi√ß√£o?
</h2>

<p>Simples, a√≠ que entra a m√°gica da inje√ß√£o de depend√™ncias. Olha que bacana:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight java"><code><span class="kd">interface</span> <span class="nc">ReviewValidator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateReview</span><span class="o">();</span>

<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CriarReviewValidator</span> <span class="kd">implements</span> <span class="nc">ReviewValidator</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">reviewText</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReviewValidator</span><span class="o">(</span><span class="nc">String</span> <span class="n">reviewText</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">reviewText</span> <span class="o">=</span> <span class="n">reviewText</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// L√≥gica de valida√ß√£o comum para todas as revis√µes</span>
        <span class="k">return</span> <span class="n">reviewText</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reviewText</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">AtualizarReviewValidator</span> <span class="kd">implements</span> <span class="nc">ReviewValidator</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">reviewText</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReviewValidator</span><span class="o">(</span><span class="nc">String</span> <span class="n">reviewText</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">reviewText</span> <span class="o">=</span> <span class="n">reviewText</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// L√≥gica de valida√ß√£o comum para todas as revis√µes</span>
        <span class="k">return</span> <span class="n">reviewText</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reviewText</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ReviewWriter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">ReviewValidator</span> <span class="n">validator</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReviewWriter</span><span class="o">(</span><span class="nc">String</span> <span class="n">reviewText</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">validator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReviewValidator</span><span class="o">(</span><span class="n">reviewText</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">validator</span><span class="o">.</span><span class="na">validateReview</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">saveReview</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Revis√£o salva com sucesso."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A revis√£o n√£o √© v√°lida e n√£o foi salva."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">saveReview</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Revis√£o salva no banco de dados: "</span> <span class="o">+</span> <span class="n">validator</span><span class="o">.</span><span class="na">reviewText</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Criar uma nova revis√£o</span>
        <span class="nc">ReviewWriter</span> <span class="n">criarReview</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReviewWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">CriarReviewValidator</span><span class="o">(</span><span class="s">"Essa n√£o √© uma boa review"</span><span class="o">));</span>
        <span class="n">criarReview</span><span class="o">.</span><span class="na">writeReview</span><span class="o">();</span>

        <span class="c1">// Atualizar uma revis√£o existente</span>
        <span class="nc">ReviewWriter</span> <span class="n">atualizarReview</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReviewWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">AtualizarReviewValidator</span><span class="o">(</span><span class="s">"Vers√£o atualizada da revis√£o."</span><span class="o">));</span>
        <span class="n">atualizarReview</span><span class="o">.</span><span class="na">writeReview</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>

</div>



<p>Viu como d√° pra fazer o mesmo comportamento usando apenas composi√ß√£o de objetos?</p>

<p>T√° blz, entendi. Mas e qual a vantagem disso? </p>

<p>Com heran√ßa, voc√™ tem um alto acoplamento entre a super-classe e suas filhas. Se voc√™ faz uma mudan√ßa na super-classe, todas as classes filhas s√£o afetadas quer voc√™ queira ou n√£o.</p>

<p>Com composi√ß√£o, os comportamentos ficam todos mais isolados. √â poss√≠vel criar novos comportamentos e inseri-los ou remov√™-los conforme voc√™ desejar e voc√™ n√£o corre o risco de afetar os <code>validators</code> caso voc√™ altere o <code>ReviewWriter</code>.</p>

<h2>
  
  
  Conclus√£o
</h2>

<p>Esse post foi escrito de forma super r√°pida, s√≥ porque eu acho o assunto interessante e fazia muito tempo que eu tinha postado algo com c√≥digo. Eu espero que voc√™s tenham curtido o assunto. </p>

<p>Se foi o caso, deixa a√≠ o like e coment√°rio que isso me incentiva a escrever mais sobre esse tipo de assunto com c√≥digo.</p>

 </details> 
 <hr /> 

 #### - [Por debaixo do cap√¥: async/await e as m√°gicas do compilador csharp](https://dev.to/angelobelchior/por-debaixo-do-capo-asyncawait-e-as-magicas-do-compilador-csharp-28ol) 
 <details><summary>Article</summary> <p>No <a href="https://dev.to/angelobelchior/por-debaixo-do-capo-c-e-acucar-sintatico-3gji">post anterior</a> eu falei um pouco sobre <strong>A√ß√∫car Sint√°tico</strong> e como o <strong>compilador do csharp</strong> trabalha para facilitar nossas vidas.</p>

<p>Propositalmente eu deixei de fora a <em>feature</em> <strong><em>async/await</em></strong>, queria fazer algo mais elaborado para explicar como as coisas funcionam por debaixo do cap√¥ quando utilizamos m√©todos ass√≠ncronos.</p>

<p>O cen√°rio que eu trago aqui √© simples e muito comum: Uma classe <strong><em>BlogService</em></strong> que cont√©m um m√©todo chamado <strong><em>ObterPostPorIdAsync</em></strong> no qual faz uma requisi√ß√£o ass√≠ncrona a uma API, utilizando o <strong><a href="https://learn.microsoft.com/pt-br/dotnet/api/system.net.http.httpclient?view=net-7.0"><em>HttpClient</em></a></strong>.</p>

<p>Eu escolhi justamente esse cen√°rio porque o m√©todo que faz a requisi√ß√£o (<strong><em>GetAsync</em></strong>) e o m√©todo que obt√©m o conte√∫do de resposta como <em>string</em> (<strong><em>ReadAsStringAsync</em></strong>) s√£o ass√≠ncronos.</p>

<blockquote>
<p>Nesse ponto eu assumo que voc√™ conhe√ßa o m√≠nimo sobre <strong>async/await</strong>, isso √© fundamental! Caso contr√°rio, recomendo fortemente estudar o assunto. Esse link da Microsfoft vai te ajudar: <a href="https://learn.microsoft.com/pt-br/dotnet/csharp/asynchronous-programming/">https://learn.microsoft.com/pt-br/dotnet/csharp/asynchronous-programming/</a></p>
</blockquote>

<p>Abaixo segue nossa classe.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="c1">// Escrito por mim</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">BlogService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">?&gt;</span> <span class="nf">ObterPostPorIdAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">postId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">endpoint</span> <span class="p">=</span> <span class="s">$"https://jsonplaceholder.typicode.com/posts/</span><span class="p">{</span><span class="n">postId</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>

        <span class="k">using</span> <span class="nn">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
        <span class="k">using</span> <span class="nn">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">endpoint</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">post</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;(</span><span class="n">json</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">post</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p>Se voc√™ j√° tem um certo conhecimento sobre <strong>csharp</strong>, consumo de apis etc., n√£o deve ter nenhuma d√∫vida sobre como esse c√≥digo funciona.</p>

<p>Por√©m, em resumo, temos:</p>

<ul>
<li>Um cliente <em>Http</em> √© criado;</li>
<li>Fazemos uma requisi√ß√£o ao <em>endpoint</em>;</li>
<li> Obtemos a resposta dessa requisi√ß√£o e extra√≠mos seu conte√∫do como <em>string</em> (nesse caso, essa <em>string</em> vem no formato <em>Json</em>) ;</li>
<li>
<em>Desserializamos</em> esse conte√∫do como um objeto <em>Post</em>.</li>
</ul>

<blockquote>
<p>Refor√ßo aqui que meu objetivo √© ser did√°tico, por isso n√£o temos <strong>valida√ß√µes do <em>response</em></strong>, <strong>pol√≠ticas de retentativas</strong> e etc.</p>
</blockquote>

<p>Se voc√™ leu atentamente o <a href="https://dev.to/angelobelchior/por-debaixo-do-capo-c-e-acucar-sintatico-3gji">post anterior</a> notou que o <strong>compilador do csharp</strong> ao gerar o c√≥digo <em>IL</em> acaba por adicionar caracteres especiais em nome de m√©todos, classes e etc, algo como:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">private</span> <span class="k">struct</span> <span class="err">&lt;</span><span class="nc">Main</span><span class="p">&gt;</span><span class="n">d__0</span>
<span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</code></pre>

</div>



<p><strong>Claramente esse c√≥digo n√£o compila!</strong> Por√©m, ao obter o c√≥digo gerado pelo compilador atrav√©s do site <a href="https://sharplab.io/">https://sharplab.io/</a> resolvi ajust√°-lo para que fosse poss√≠vel sua execu√ß√£o.</p>

<p>Respira fundo! Vai com calma e n√£o se preocupe! Eu vou explicar direitinho o que acontece por debaixo do cap√¥:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="c1">// Gerado pelo compilador, ajustado por mim</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">BlogService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">struct</span> <span class="nc">ObterPostPorIdAsyncStateMachine</span> <span class="p">:</span> <span class="n">IAsyncStateMachine</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">State</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">AsyncTaskMethodBuilder</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;</span> <span class="n">Builder</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">PostId</span><span class="p">;</span>

        <span class="k">private</span> <span class="n">HttpClient</span> <span class="n">_httpClient</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">HttpResponseMessage</span> <span class="n">_httpResponseMessage</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">_awaiterHttpResponseMessage</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_awaiterContentString</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">MoveNext</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">num</span> <span class="p">=</span> <span class="n">State</span><span class="p">;</span>
            <span class="n">Post</span> <span class="n">result</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">requestUri</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="kt">string</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">defaultInterpolatedStringHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultInterpolatedStringHandler</span><span class="p">(</span><span class="m">43</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
                    <span class="n">defaultInterpolatedStringHandler</span><span class="p">.</span><span class="nf">AppendLiteral</span><span class="p">(</span><span class="s">"https://jsonplaceholder.typicode.com/posts/"</span><span class="p">);</span>
                    <span class="n">defaultInterpolatedStringHandler</span><span class="p">.</span><span class="nf">AppendFormatted</span><span class="p">(</span><span class="n">PostId</span><span class="p">);</span>
                    <span class="n">requestUri</span> <span class="p">=</span> <span class="n">defaultInterpolatedStringHandler</span><span class="p">.</span><span class="nf">ToStringAndClear</span><span class="p">();</span>
                    <span class="n">_httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="n">awaiter</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">goto</span> <span class="n">IL_00b6</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">awaiter</span> <span class="p">=</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">requestUri</span><span class="p">).</span><span class="nf">GetAwaiter</span><span class="p">();</span>
                        <span class="k">if</span> <span class="p">(!</span><span class="n">awaiter</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="m">0</span><span class="p">);</span>
                            <span class="n">_awaiterHttpResponseMessage</span> <span class="p">=</span> <span class="n">awaiter</span><span class="p">;</span>
                            <span class="n">Builder</span><span class="p">.</span><span class="nf">AwaitUnsafeOnCompleted</span><span class="p">(</span><span class="k">ref</span> <span class="n">awaiter</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="n">awaiter</span> <span class="p">=</span> <span class="n">_awaiterHttpResponseMessage</span><span class="p">;</span>
                        <span class="n">_awaiterHttpResponseMessage</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;);</span>
                        <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="kt">var</span> <span class="n">httpResponseMessage</span> <span class="p">=</span> <span class="p">(</span><span class="n">_httpResponseMessage</span> <span class="p">=</span> <span class="n">awaiter</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">());</span>
                    <span class="k">goto</span> <span class="n">IL_00b6</span><span class="p">;</span>
                    <span class="n">IL_00b6</span><span class="p">:</span>
                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">awaiter2</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">!=</span> <span class="m">1</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">awaiter2</span> <span class="p">=</span> <span class="n">_httpResponseMessage</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="nf">GetAwaiter</span><span class="p">();</span>
                            <span class="k">if</span> <span class="p">(!</span><span class="n">awaiter2</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="m">1</span><span class="p">);</span>
                                <span class="n">_awaiterContentString</span> <span class="p">=</span> <span class="n">awaiter2</span><span class="p">;</span>
                                <span class="n">Builder</span><span class="p">.</span><span class="nf">AwaitUnsafeOnCompleted</span><span class="p">(</span><span class="k">ref</span> <span class="n">awaiter2</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">);</span>
                                <span class="k">return</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="n">awaiter2</span> <span class="p">=</span> <span class="n">_awaiterContentString</span><span class="p">;</span>
                            <span class="n">_awaiterContentString</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;);</span>
                            <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span> <span class="c1">//Reinicia a m√°quina de estados...</span>
                        <span class="p">}</span>
                        <span class="n">result</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;(</span><span class="n">awaiter2</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">());</span>
                    <span class="p">}</span>
                    <span class="k">finally</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">_httpResponseMessage</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">_httpResponseMessage</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">finally</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">_httpClient</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">_httpClient</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">2</span><span class="p">;</span>
                <span class="n">_httpClient</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="n">_httpResponseMessage</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="n">Builder</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">2</span><span class="p">;</span>
            <span class="n">_httpClient</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">_httpResponseMessage</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">Builder</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">void</span> <span class="n">IAsyncStateMachine</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//ILSpy generated this explicit interface implementation from .override directive in MoveNext</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">SetStateMachine</span><span class="p">(</span><span class="n">IAsyncStateMachine</span> <span class="n">stateMachine</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Builder</span><span class="p">.</span><span class="nf">SetStateMachine</span><span class="p">(</span><span class="n">stateMachine</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">void</span> <span class="n">IAsyncStateMachine</span><span class="p">.</span><span class="nf">SetStateMachine</span><span class="p">(</span><span class="n">IAsyncStateMachine</span> <span class="n">stateMachine</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//ILSpy generated this explicit interface implementation from .override directive in SetStateMachine</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">SetStateMachine</span><span class="p">(</span><span class="n">stateMachine</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;</span> <span class="nf">ObterPostPorIdAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">postId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">ObterPostPorIdAsyncStateMachine</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">Builder</span> <span class="p">=</span> <span class="n">AsyncTaskMethodBuilder</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;.</span><span class="nf">Create</span><span class="p">();</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">PostId</span> <span class="p">=</span> <span class="n">postId</span><span class="p">;</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="k">ref</span> <span class="n">stateMachine</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">stateMachine</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">record</span> <span class="nf">Post</span><span class="p">(</span>
    <span class="p">[</span><span class="n">property</span><span class="p">:</span> <span class="nf">JsonPropertyName</span><span class="p">(</span><span class="s">"id"</span><span class="p">)]</span> <span class="kt">int</span> <span class="n">Id</span><span class="p">,</span>
    <span class="p">[</span><span class="n">property</span><span class="p">:</span> <span class="nf">JsonPropertyName</span><span class="p">(</span><span class="s">"title"</span><span class="p">)]</span> <span class="kt">int</span> <span class="n">Title</span><span class="p">,</span>
    <span class="p">[</span><span class="n">property</span><span class="p">:</span> <span class="nf">JsonPropertyName</span><span class="p">(</span><span class="s">"body"</span><span class="p">)]</span> <span class="kt">int</span> <span class="n">Body</span><span class="p">);</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">blog</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlogService</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">post</span> <span class="p">=</span> <span class="k">await</span> <span class="n">blog</span><span class="p">.</span><span class="nf">ObterPostPorIdAsync</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">post</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--Ex948tR0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p6tp8n05koe7v90hyewh.jpg" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Ex948tR0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p6tp8n05koe7v90hyewh.jpg" alt='Jackie Chan e Cris Rock no filme "A hora do Rush" numa cena dentro de um taxy fazendo cara de p√¢nico' width="800" height="450"></a></p>

<p>Sem p√¢nico!</p>

<p>Antes de tudo, vamos nos concentrar apenas na classe <em>BlogService</em>! A classe <em>Program</em> e o record <em>Post</em> servem s√≥ de apoio!</p>

<p>Numa primeira an√°lise notamos o quanto de c√≥digo o compilador gerou e fica n√≠tido que o foco √© que ele seja perform√°tico e gere a menor quantidade de aloca√ß√µes poss√≠vel.</p>

<p>Ali√°s, a complexidade cognitiva do m√©todo <em>MoveNext</em> da <em>struct</em> <em>ObterPostPorIdAsyncStateMachine</em> √© de 18, sendo que o aceit√°vel √© 10.</p>

<p>Eu uso um <a href="https://plugins.jetbrains.com/plugin/12024-cognitivecomplexity">plugin no Rider</a> que me d√° essa informa√ß√£o:</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--mpqsjTD9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rasjw13vbbiuzjzy55nm.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--mpqsjTD9--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rasjw13vbbiuzjzy55nm.png" alt="Image description" width="702" height="185"></a></p>

<p>Mas fa√ßo quest√£o de refor√ßar mais uma vez que esse √© o c√≥digo mais <strong>otimizado poss√≠vel para essa situa√ß√£o</strong>. O <a href="https://github.com/dotnet/roslyn">time de desenvolvimento do compilador do csharp</a> trabalha √°rduamente para que a cada vers√£o sejam inclu√≠das mais e mais otimiza√ß√µes em todo o processo de compila√ß√£o!</p>

<p>Por√©m, <a href="https://www.youtube.com/shorts/huBEoFijyU8">diferente do Baianinho de Mau√°</a>, <strong>as m√°gicas que o compilador faz N√ÉO S√ÉO INFINITAS</strong>. Se seu c√≥digo n√£o for minimante bem escrito, n√£o vai adiantar nada, <strong>por isso √© importante entendermos o que se passa por debaixo do cap√¥!</strong>.</p>

<p><strong>Vamos ao que interessa!</strong></p>

<p>A primeira coisa que precisamos entender √© que o processo ass√≠ncrono √© gerenciado por uma <a href="https://pt.wikipedia.org/wiki/M%C3%A1quina_de_estados_finita"><strong>m√°quina de estados</strong></a>.</p>

<p>Dentro da classe <em>BlogService</em> √© criada uma <em>struct</em> privada chamada <em>ObterPostPorIdAsyncStateMachine</em>. <strong>√â nessa <em>struct</em> que toda m√°gica acontece</strong>. Cada m√©todo ass√≠ncrono existente na classe <em>BlogService</em> teria sua pr√≥pria m√°quina de estados. Nesse caso criei apenas um m√©todo para fins did√°ticos.</p>

<p>Essa <em>struct</em> implementa a interface <em>IAsyncStateMachine</em> que fica dentro do namespace <em>System.Runtime.CompilerServices</em> e cont√©m os seguintes m√©todos:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IAsyncStateMachine</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">MoveNext</span><span class="p">();</span>
    <span class="k">void</span> <span class="nf">SetStateMachine</span><span class="p">(</span><span class="n">IAsyncStateMachine</span> <span class="n">stateMachine</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

</div>



<p><strong>Essa interface representa uma m√°quina de estados geradas para m√©todos ass√≠ncronos e √© destinada apenas ao uso do compilador.</strong></p>

<p>O m√©todo <em>MoveNext()</em> move a m√°quina de estados para o pr√≥ximo estado.</p>

<p>J√° o m√©todo <em>SetStateMachine(IAsyncStateMachine stateMachine)</em> seta a m√°quina de estados com uma r√©plica alocada na mem√≥ria <em>heap</em>.</p>

<p>Essa m√°quina <strong>tem 4 estados</strong> que s√£o armazenados na vari√°vel global do tipo <em>int</em> chamada <em>State</em>. Note que dentro do m√©todo <em>MoveNext</em> o valor da vari√°vel <em>State</em> √© copiado para a vari√°vel <em>num</em>. <strong>Alterar diretamente o valor de uma vari√°vel global numa m√°quina de estados pode ser perigoso e trazer efeitos colaterais indesejados</strong>. Essa vari√°vel global s√≥ vai receber um valor quando seu estado, de fato, mudar.</p>

<p><strong>Estado <u>Inicial</u>: State = -1:</strong> </p>

<p>Ao invocar o m√©todo <em>MoveNext</em> pela primeira vez, a m√°quina de estados √© iniciada. √â nesse momento onde as vari√°veis s√£o criadas.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">defaultInterpolatedStringHandler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultInterpolatedStringHandler</span><span class="p">(</span><span class="m">43</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="n">defaultInterpolatedStringHandler</span><span class="p">.</span><span class="nf">AppendLiteral</span><span class="p">(</span><span class="s">"https://jsonplaceholder.typicode.com/posts/"</span><span class="p">);</span>
    <span class="n">defaultInterpolatedStringHandler</span><span class="p">.</span><span class="nf">AppendFormatted</span><span class="p">(</span><span class="n">PostId</span><span class="p">);</span>
    <span class="n">requestUri</span> <span class="p">=</span> <span class="n">defaultInterpolatedStringHandler</span><span class="p">.</span><span class="nf">ToStringAndClear</span><span class="p">();</span>
    <span class="n">_httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>

</div>



<p>Ap√≥s a cria√ß√£o das vari√°veis, √© <strong>solicitada</strong> a requisi√ß√£o. Note que eu usei a palavra <strong>solicitada</strong> e n√£o <strong>efetuada</strong>, afinal, como √© mostrado no c√≥digo, a vari√°vel <em>awaiter</em> est√° aguardando o processamento...<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="n">awaiter</span> <span class="p">=</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">requestUri</span><span class="p">).</span><span class="nf">GetAwaiter</span><span class="p">();</span>
</code></pre>

</div>



<p>... e com isso, damos in√≠cio ao segundo estado...</p>

<p><strong>Estado <u>Em Execu√ß√£o</u>: State = 0:</strong><br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">if</span> <span class="p">(!</span><span class="n">awaiter</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="m">0</span><span class="p">);</span>
    <span class="n">_awaiterHttpResponseMessage</span> <span class="p">=</span> <span class="n">awaiter</span><span class="p">;</span>
    <span class="n">Builder</span><span class="p">.</span><span class="nf">AwaitUnsafeOnCompleted</span><span class="p">(</span><span class="k">ref</span> <span class="n">awaiter</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

</div>



<p>A vari√°vel <em>awaiter</em> tem uma propriedade chamada <em>IsCompleted</em> que indica se o processo est√° completo ou n√£o (<em>true/false</em>).<br>
Como estamos na primeira rodada do processamento (o m√©todo <em>MoveNext</em> foi acionado apenas uma vez), esse <em>IsCompleted</em> √© falso, fazendo com que o estado (<em>State</em>) fique com o valor 0 e que seja invocado o m√©todo <strong><em>Builder.AwaitUnsafeOnCompleted(ref awaiter, ref this);</em></strong>.</p>

<p><strong>Esse √© o ponto chave de todo o fluxo!</strong></p>

<p>Esse m√©todo recebe o objeto que est√° aguardando a finaliza√ß√£o de um processo (<em>awaiter</em>) e qual objeto que o invocou (<em>this</em>), sendo esse um tipo que implemente a interface <em>IAsyncStateMachine</em>. <a href="https://learn.microsoft.com/pt-br/dotnet/csharp/language-reference/keywords/ref">Tudo via refer√™ncia</a>.</p>

<p>Basicamente o <em>AwaitUnsafeOnCompleted</em> vai esperar por alguma mudan√ßa de estado no processamento do m√©todo aguardado pelo <em>awaiter</em> (_<em>httpClient.GetAsync(requestUri)</em>) e em seguida invoca o m√©todo <em>MoveNext</em> da <em>struct</em> que o invocou (<em>ObterPostPorIdAsyncStateMachine</em>). </p>

<p><strong>Temos aqui um looping</strong>: Enquanto o <em>awaiter.IsCompleted</em> n√£o for <em>true</em>, <em>State</em> vai ficar como 0 e o m√©todo <em>Builder.AwaitUnsafeOnCompleted</em> vai ser invocado novamente.</p>

<p>Esse processo todo tamb√©m vai ocorrer quando estamos lendo o conte√∫do do <em>response</em> ap√≥s a requisi√ß√£o ser efetuada com sucesso:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="n">awaiter2</span> <span class="p">=</span> <span class="n">_httpResponseMessage</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="nf">GetAwaiter</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(!</span><span class="n">awaiter2</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="m">1</span><span class="p">);</span>
    <span class="n">_awaiterContentString</span> <span class="p">=</span> <span class="n">awaiter2</span><span class="p">;</span>
    <span class="n">Builder</span><span class="p">.</span><span class="nf">AwaitUnsafeOnCompleted</span><span class="p">(</span><span class="k">ref</span> <span class="n">awaiter2</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

</div>



<p><strong>Perceba que o fluxo √© exatamente o mesmo!</strong></p>

<p>Ap√≥s os <em>awaiters</em> derem o sinal de que foram executados (<em>IsCompleted == true</em>) passamos para o pr√≥ximo estado da nossa m√°quina.</p>

<p><strong>Estado <u>Obtendo Resultado</u>: State = 1:</strong> </p>

<p>Aqui chegamos ao final do nosso processo.</p>

<p>Com o <em>json</em> obtido atrav√©s do <em>response</em> vamos desserializa-lo e criar um objeto <em>Post</em>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">!=</span> <span class="m">1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// *solitita* o conte√∫do do response... </span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="n">awaiter2</span> <span class="p">=</span> <span class="n">_awaiterContentString</span><span class="p">;</span>
    <span class="n">_awaiterContentString</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;);</span>
    <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span> <span class="c1">//Reinicia a m√°quina de estados...</span>
<span class="p">}</span>
<span class="n">result</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;(</span><span class="n">awaiter2</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">());</span>
</code></pre>

</div>






<p>√â poss√≠vel notar o uso do <strong>go to</strong> (que me lembra o saudoso e famigerado VB6: <strong>On Error go to Hell</strong>).<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">goto</span> <span class="n">IL_00b6</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>

<span class="n">IL_00b6</span><span class="p">:</span>  <span class="c1">// &lt;--------</span>
<span class="k">try</span>  
<span class="p">{</span>  
    <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">awaiter2</span><span class="p">;</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">!=</span> <span class="m">1</span><span class="p">)</span>  
    <span class="p">{</span> 
        <span class="n">awaiter2</span> <span class="p">=</span> <span class="n">_httpResponseMessage</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="nf">GetAwaiter</span><span class="p">();</span>  
        <span class="k">if</span> <span class="p">(!</span><span class="n">awaiter2</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>  
        <span class="p">{</span> 
        <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="m">1</span><span class="p">);</span>  
            <span class="n">_awaiterContentString</span> <span class="p">=</span> <span class="n">awaiter2</span><span class="p">;</span>  
            <span class="n">Builder</span><span class="p">.</span><span class="nf">AwaitUnsafeOnCompleted</span><span class="p">(</span><span class="k">ref</span> <span class="n">awaiter2</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">);</span>  
            <span class="k">return</span><span class="p">;</span>  
        <span class="p">}</span> 
    <span class="p">}</span>  
    <span class="k">else</span>  
    <span class="p">{</span>  
        <span class="n">awaiter2</span> <span class="p">=</span> <span class="n">_awaiterContentString</span><span class="p">;</span>  
        <span class="n">_awaiterContentString</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;);</span>  
        <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>  
    <span class="p">}</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;(</span><span class="n">awaiter2</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">());</span>  
<span class="p">}</span>  
<span class="k">finally</span>  
<span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">_httpResponseMessage</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>  
    <span class="p">{</span> 
        <span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">_httpResponseMessage</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span>  
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p>O compilador utiliza o <strong>go to</strong> de maneira estrat√©gica, fazendo com que o c√≥digo desvie para o trecho onde o segundo <em>awaiter</em> est√°:  <strong>_awaiter2 = _httpResponseMessage.Content.ReadAsStringAsync().GetAwaiter();</strong><em>. Imagine que cada m√©todo _async</em> dentro desse processo poderia ter o seu <strong>go to</strong> justamente para que o c√≥digo consiga alcan√ß√°-lo a partir do momento que o m√©todo <em>MoveNext</em> fosse executado. Normalmente usar√≠amos um <strong>if</strong> ou <strong>quebrar√≠amos o m√©todo em v√°rias partes</strong>, mas como disse, o compilador escolhe <strong>a melhor maneira para ele</strong> e <strong>n√£o para quem est√° lendo o c√≥digo</strong>.</p>




<p>E se por acaso explodir um erro?</p>

<p><strong>Estado <u>Ocorreu um Erro</u>: State = -2:</strong> </p>

<p>Todo processo √© envolvido por um <em>try/catch</em> e caso ocorra um erro, o <em>State</em> √© mudado para -2, as vari√°veis s√£o setadas como nulo e o <em>builder</em> armazena a <em>exception</em> gerada.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>  
<span class="p">{</span>  
  <span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">2</span><span class="p">;</span>  
  <span class="n">_httpClient</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>  
  <span class="n">_httpResponseMessage</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>  
  <span class="n">Builder</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="n">exception</span><span class="p">);</span>  
  <span class="k">return</span><span class="p">;</span>  
<span class="p">}</span>
</code></pre>

</div>



<p>Ainda temos trechos de c√≥digo que s√£o utilizados para darem <em>dispose</em> nos objetos. Se voc√™ acompanhou o <a href="https://dev.to/angelobelchior/por-debaixo-do-capo-c-e-acucar-sintatico-3gji">post anterior</a> deve ter notado que a instru√ß√£o <em>using</em> se torna um <em>try/finally</em>, e √© no <em>finally</em> que os objetos s√£o "descartados".<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="p">...</span>

<span class="k">finally</span>  
<span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">_httpResponseMessage</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>  
    <span class="p">{</span> 
        <span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">_httpResponseMessage</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span>  
    <span class="p">}</span>
 <span class="p">}</span>
<span class="p">...</span>

<span class="k">finally</span>  
<span class="p">{</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">_httpClient</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>  
    <span class="p">{</span> 
        <span class="p">((</span><span class="n">IDisposable</span><span class="p">)</span><span class="n">_httpClient</span><span class="p">).</span><span class="nf">Dispose</span><span class="p">();</span>  
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p>Por fim, e n√£o menos importante temos o m√©todo: <em>ObterPostPorIdAsync</em>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight csharp"><code><span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;</span> <span class="nf">ObterPostPorIdAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">postId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">ObterPostPorIdAsyncStateMachine</span><span class="p">);</span>
    <span class="n">stateMachine</span><span class="p">.</span><span class="n">Builder</span> <span class="p">=</span> <span class="n">AsyncTaskMethodBuilder</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;.</span><span class="nf">Create</span><span class="p">();</span>
    <span class="n">stateMachine</span><span class="p">.</span><span class="n">PostId</span> <span class="p">=</span> <span class="n">postId</span><span class="p">;</span>
    <span class="n">stateMachine</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
    <span class="n">stateMachine</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="k">ref</span> <span class="n">stateMachine</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">stateMachine</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>

</div>



<p>Esse trecho n√£o tem segredo! √â nele onde os valores iniciais s√£o setados e a m√°quina de estados √© criada e inicializada.</p>




<p>Se voc√™ leu com aten√ß√£o deve ter notado duas coisas:</p>

<ul>
<li>O <em>async</em> n√£o existe! Essa <em>keyword</em> simplesmente some no c√≥digo gerado.</li>
<li>A √∫nica <em>Task</em> que temos √© a que o <em>builder</em> da m√°quina de estados gera de retorno para o m√©todo <em>ObterPostPorIdAsync</em>: <strong><em>return stateMachine.Builder.Task;</em></strong>.</li>
</ul>

<p>E √© aqui aonde quero chegar: <strong>eu quis com esse post mostrar como o compilador lida com o <em>async/await</em></strong>, <strong>como que o c√≥digo √© gerado</strong> e <strong>qual √© a estrat√©gia que ele usa para saber quando um processo terminou ou lan√ßou um erro</strong>.</p>

<p>A classe <strong><a href="https://learn.microsoft.com/pt-br/dotnet/api/system.threading.tasks.task?view=net-7.0">Task</a></strong> por si s√≥ mereceria um post todinho s√≥ para ela. </p>

<p>Fora que ainda existem outros cen√°rios que eu n√£o cobri aqui, <strong>mas cobrirei em breve</strong>, como por exemplo <strong>o uso mal√©fico, maligno, molecular e abomin√°vel do .Result</strong>, <strong>CancellationToken</strong> em m√©todos ass√≠ncronos, <strong>a fun√ß√£o do .ConfigureAwait(true/false)</strong> e o <strong>tratamento de exce√ß√µes</strong>. </p>

<p><strong>Quero escrever um post para cada um desses itens</strong> dando a devida aten√ß√£o.</p>




<p>Para entender melhor todo o fluxo disponibilizei no github o <a href="https://github.com/angelobelchior/AsyncAwaitSample">c√≥digo fonte</a>!<br>
<strong>Coloque um <em>break point</em> dentro do m√©todo <em>MoveNext</em> e v√° navegando linha a linha.</strong></p>

<p>Quer ir mais afundo nesse assunto?<br>
Esse √©, sem d√∫vidas, um dos melhores posts sobre <em>async/await</em>: <a href="https://devblogs.microsoft.com/pfxteam/asyncawait-faq/">https://devblogs.microsoft.com/pfxteam/asyncawait-faq/</a>. <br>
E a melhor parte est√° nos coment√°rios. Leitura obrigat√≥ria.</p>

<p>Era isso, at√© a pr√≥xima!</p>




<p>N√£o vai embora n√£o!!</p>

<p><strong>Vem com a gente turma! Depois de anos e anos colocando sistemas em produ√ß√£o, resolvemos criar um curso completo sobre Clean Architecture e Clean Code com .Net. De Dev pra Dev! Presencial! Na pr√°tica! Vagas limitadas!</strong></p>

<p><strong>DIA 25 DE NOVEMBRO DE 2023, no Espa√ßo Paulista Promo√ß√µes de Eventos.</strong></p>

<p><strong><u>Acesse: <a href="https://vemcodar.com.br/">https://vemcodar.com.br/</a></u></strong></p>

 </details> 
 <hr /> 

 #### - [A simple architecture for Flutter apps](https://dev.to/jckodel/a-simple-architecture-for-flutter-apps-2424) 
 <details><summary>Article</summary> <h1>
  
  
  A simple architecture for Flutter apps
</h1>

<p><a href="https://pub.dev/packages/simple_architecture">https://pub.dev/packages/simple_architecture</a></p>

<p><a href="https://github.com/kodel-dynamics/simple_architecture">https://github.com/kodel-dynamics/simple_architecture</a></p>

<h2>
  
  
  Objectives
</h2>

<h3>
  
  
  Reusability
</h3>

<p>Certain parts of an application are common to multiple applications, such as authentication. What differs are only certain settings, such as <code>clientId</code> or <code>redirectUri</code> that are specific to each application. Therefore, there is no reason to write the same code for different applications.</p>

<p>It is necessary that common parts of an application are reusable in other applications with <em>no</em> changes and, at the same time, allow the parts that actually perform the service to be interchangeable, that is, if authentication is done with the <code>sign_in_with_apple packages</code> and <code>firebase_auth</code> and, for any reason (such as a better package being built in the future, or a customer requirement needing to use Amazon Cognito or Auth0), these parts must be replaceable without any other part of the application or of reusable code is changed.</p>

<p>This is possible through the concept of repositories. Although the repository definition is specific to databases (<a href="https://martinfowler.com/eaaCatalog/repository.html">https://martinfowler.com/eaaCatalog/repository.html</a>), nothing prevents the same concept from being used for any operation that performs I/O, such as reading and writing files, remote calls via REST or GraphQL and access to third-party packages such as <code>firebase_auth</code>. So, any part of the system that communicates in any way to any external part of the system is done through a contract (interface) that specifies what that component does (for authentication, basically it is necessary to know the authenticated user, enter and leave one account). So the parts of the system that are interchangeable are just implementations of such interfaces and adaptations to the entities that the system understands (for example, there is a class that stores user information such as id, name, email and photo url (avatar )). The authentication interface asks for this class of representation of a user, so it is the implementation's job to turn what it considers a user into the entity that the application understands (i.e., it is the repository's job to convert what represents a user to it (e.g. .: <code>User</code> to <code>firebase_auth</code>) in the entity that the application understands.</p>

<p>This objective is met with two library features: services and dependency injection.</p>

<h3>
  
  
  Feature units
</h3>

<p>When we talk about S.O.L.I.D., the "S" refers to <strong>single responsibility</strong>. Unfortunately, "responsibility" is a very vague thing. Is authentication a single responsibility? Authentication typically has several components such as logging into an account, logging out of an account, checking the authenticated user if present, persisting the authenticated user, taking care of tokens, etc.</p>

<p>To make things extremely clear, it is necessary that such responsibilities are truly unique: instead of one big "authentication" responsibility, it is necessary to create a folder to group all the small features that make up an authentication system. Each feature being something to be implemented that does only that thing (that is, in an application that has an authentication system, we have <em>features</em> such as <em>sign in</em>, <em>log out</em>, <em>change user name</em>, <em>change user photo *, etc. These are distinct features that do not interfere with other features and, ideally, can be implemented at different times (i.e.: I don't need to complete *sign in</em> to <em>change user name</em> and vice versa).</p>

<p>This objective is achieved with a granulation of <em>features</em> through organized folders and files, an event system to specify what is desired (e.g.: <code>SignInUser(AuthProvider.google)</code>) to request to sign in with a user, using the Google for this, or <code>ChangeUserName(user.id, newName)</code> to request a user's name change and a mediator to understand and implement such events. This mediator has access to the same dependency injection system used in services, so it becomes a simple cake recipe on how to implement such a <em>feature</em>, using external services to guarantee this (i.e., at this point, there are only rules business, no knowledge of external services, such as Firebase Auth, and injectable dependencies, so that such an implementation can be easily tested).</p>

<h3>
  
  
  Settings
</h3>

<p>When parts of the system are reusable, generally what differs in use are configurations. For example, in an authentication system, we have certain settings such as <em>Google Client Id</em>, <em>Apple Service Id</em>, <em>Apple Redirect Uri</em>, etc.</p>

<p>While such settings can be injected into dependencies via parameters (during dependency registration), we can often have variable settings (e.g. a preference saved in <code>shared_preferences</code> or mutable settings via Firebase Remote Config.</p>

<p>This objective is achieved with a dependency injection system for classes that store configurations and that have mechanisms for updating these configurations in the dependency injector.</p>

<h3>
  
  
  State
</h3>

<p>There is a lot of discussion about state management in Flutter. Huge (and extremely complex) frameworks are built around this, like BLoC and Riverpod. The problem is that state is something simple: you don't even need a framework for state management in Flutter, as the library provides countless ways to maintain global and local states without needing external packages, such as <code>InheritedWidget</code>, <code>InheritedModel</code>, <code>ChangeNotifier</code>, <code>ValueNotifier&lt;T&gt;</code> and <code>Stream&lt;T&gt;</code>. For example, in Firebase Auth, there is a <code>Stream&lt;User?&gt;</code> that fires during startup and whenever a user signs in or out. Any part of the system that depends on a user being authenticated or that displays information about that user (such as, for example, their photo) only needs to listen to the changes written to this stream, with a <code>StreamBuilder</code>. And states are that simple. Nothing more advanced is necessary in the vast majority of cases.</p>

<p>This goal is accomplished with a simple state management system based on <code>ValueNotifier&lt;T&gt;</code> (usable in the UI with a <code>ValueListenableBuilder&lt;T&gt;(valueListenable: $state.get&lt;AuthState&gt;(), builder: (context, authenticatedUser) =&gt; authenticatedUser == null ? LoginPage() : HomePage())</code>). Because the state manager participates in the dependency injection system, it can have dependencies injected and can be injected into other services.</p>

<p>To ensure that a state has a valid value during app initialization, these states must be initialized during app initialization and their initial values must be loaded. To fulfill this requirement, the state manager has <code>load</code> and <code>save</code> methods, where <code>load</code> loads a state (which can be a fixed default value or a value read from a local database, e.g. to maintain the state the app had during the last run) and <code>save</code> which can be implemented (or ignored) to save the current state of the application so that it returns to the same previous state when restarted. Additionally, a <code>change</code> method is used to change the state that the manager has (thus triggering the necessary events for the <code>ValueListenableBuiler&lt;T&gt;</code> to generate a rebuild, in case the state is different from the previous one.</p>

<h3>
  
  
  Overseers
</h3>

<p>Many times, we need to see or take care of certain things that our services cannot do (or should not do, due to the single responsibility principle, or because it is cumbersome to add monitoring to every existing call or <em>feature</em>, thus creating duplication of code).</p>

<p>Things that would be interesting to implement: central exception management, where every exception is shown, both locally and remotely (with services like Sentry or Firebase Crashlytics). A system that allows you to measure how long each <em>feature</em> of the system takes to execute, to check for bottlenecks or even anomalies, perhaps with remote services, such as Firebase Performance. Audit logs, to know exactly what was called, what the inputs and outputs were for that call, etc.</p>

<p>To accomplish this goal, there are classes called <code>PipelineBehavior</code> that intercept each system call to add such features. Each pipeline has a priority number (from 0 to infinity, with 0 running first). Then we can create pipelines that encapsulate all service calls in a <code>try/catch</code> and, if an exception occurs, send it, for example, to Firebase Crashlytics. Similarly, a pipeline with very high priority (say 1000), running immediately before the <em>handler</em> of the call actually has a time meter using <code>Stopwatch</code>.</p>

<h3>
  
  
  S.O.L.I.D.
</h3>

<p>The S.O.L.I.D. principles They are very common in projects written by more senior and experienced people. Although not every aspect of each part of this principle makes sense today, some are extremely indispensable:</p>

<p>1) <strong>S</strong>: <em>Single responsibility</em>: As described above, each written business rule must take care of one and only one responsibility. The more granular you are, the more classes there are, but the easier it is to find and fix problems. The less granular, the more responsibilities a module will have and the greater chance of problems, although fewer classes will exist. The final amount of useful code (that implements the solution to the problem) does not differ by grain.<br>
2) <strong>O</strong>: <em>Open-Closed principle</em>: Basically, a system must be open to modifications (e.g.: implementing Auth0 instead of Firebase Auth) without anything else in the system changing. For nothing else in the system to change, the <em>features</em> need to be closed (<em>closed</em>). In this library, we use the <em>Polymorphic open-closed principle</em> which is nothing more than the freedom (<em>open</em>) to implement things as you wish, but have a fixed contract so that the application does not need to change to accommodate such changes (<em>closed</em>) through interfaces injected into business rules.<br>
3) <strong>L</strong>: <em>Liskov substitution principle</em>: Basically it says that a class can be replaced by another class that is part of its inheritance chain without the system breaking as a result. This principle is used in the example of authentication due to a limitation of the dependency system: we have a part of the authentication system that is OAuth authentication with an external provider (Google, Facebook, Apple, etc.). Each provider has to be registered, but we cannot have an interface for both (as the dependency injector registers an interface type for each implementation). Therefore, we need to create an interface of type <code>IOAuthService</code> and two interfaces that inherit it such as <code>IGoogleOAuthService</code> and <code>IAppleOAuthService</code>. All of these interfaces can be interchanged without anything breaking, as they will not add or remove features (at least in terms of whoever uses them: the library). This represents exactly the same as covariance in Dart, most commonly implemented in <code>InheritedWidgets</code>, where the method that must be overridden <code>updateShouldNotify</code> comes with a covariance (i.e.: the new type you are creating can - and should - be replaced in this <em>override</em> and nothing will break so: <code>bool updateShouldNotify(covariant InheritedWidget oldWidget)</code>.<br>
4) <strong>I</strong>: <em>Interface segregation principle</em>: This principle is about breaking down certain functionalities that certain classes have in a granular way: instead of a large contract that specifies several functionalities that may not even be usable by a target, segregation breaks such functionalities into smaller parts. For example, in services, we have purely decorative interfaces that follow this principle, such as <code>IInitializable</code> which requires the implementation of <code>void initialize()</code> and <code>IBootable</code> which requires the implementation of <code>Future&lt;void&gt; initializeAsync()</code> in parts distinct from the system (the first is executed every time an injected class is instantiated, the second is specific to <em>singletons</em> and is executed during the library initialization process). An example of not following this principle would be to place both initialization methods in the same interface, causing the classes that implement them to ignore such decorations by implementing empty methods (that is, if you have an empty method in a class just because one interface requires this, this interface is not following the interface segregation principle).<br>
5) <strong>D</strong>: <em>Dependency inversion principle</em>: This principle is what allows you to write modular code, meaning that the common parts (logic) can be shared and written only once and the implementation details are free to be implemented differently for each project or even be changed in the same project without compromising functionality or rewriting. Dependency injection is used in all aspects of this library.</p>
<h3>
  
  
  Y.A.G.N.I.
</h3>

<p><em>You ain't gonna need it</em> is a principle that says that you shouldn't implement something (or leave tips to implement in the future) of something that you won't use at the moment. This requirement is met with granular <em>features</em> that implement little and are independent, so that it is not necessary to implement other parts just for the sake of implementing or leaving future implementation tips in a <em>feature</em>.</p>
<h3>
  
  
  D.R.Y.
</h3>

<p><em>Don't Repeat Yourself</em> is a principle that says that you should not repeat a single line of code to implement more than one functionality. This requirement is met with <em>pipeline behaviors</em> to implement features used at multiple points once (as opposed to, for example, adding error handling to each of the <em>features</em> separately). What if one is forgotten? What if you want to add functionality like reporting an error to Firebase Crashlytics? If more than one point in the code must be changed to accomplish this objective, then the code is not D.R.Y.</p>
<h3>
  
  
  Exceptions as flow control
</h3>

<p>Exceptions are almost always used as flow control, rather than representing an error from which we cannot recover. For example, the <code>sign_in_with_apple</code> package generates an exception of type <code>SignInWithAppleAuthorizationException</code> with the code <code>AuthorizationErrorCode.canceled</code> when the user cancels the authentication flow. This is not a good thing as this is not a mistake. The program flow is interrupted and transferred to a <code>catch</code> clause or, worse, if no <code>catch</code> is in the context, the application simply stops working, just because the user gave up signing in with an Apple account!</p>

<p>In Flutter, there is an additional problem in using exceptions when we are working with Flutter Web: certain exceptions, such as <code>SocketException</code> are present in a module that we should not import in this environment (<code>dart:io</code>). Making our reusable code depend on extra checks whether we are in web mode or not can become quite laborious.</p>

<p>Additionally, there are exceptions that represent the same error, but are triggered by different exceptions: for example, when there is no internet available and we try to access something remote, we may receive a <code>SocketException</code>, a <code>DioException</code> if we are using <code>dio</code> or, in the case of authentication, a <code>FirebaseAuthException</code> or even a <code>PlatformException</code>. It all boils down to the same failure: <code>networkRequestFailed</code> and it should be easier to deal with this in the UI: instead of handling 4 different types of exceptions (and others in the future when more functionality is implemented), services could just return a " result loader", i.e., a class that contains a success state, with the value returned by the service (e.g., the authenticated user), or a failure state, which contains only a description of the failure (e.g., a <code>SignInFailure</code> enum which contains all problems that may occur during authentication and an <code>unknown</code> for anything else unexpected). So, in our UI (or at any other point), we don't depend on classes and exceptions, but a simple enum (which is very interesting because Dart warns us when we try to use an enum in a <code>switch</code> and we don't cover all the possibilities existing).</p>

<p>To do this, we can use a class like <code>Result&lt;TValue, TFailure extends Enum&gt;()</code> with the constructors <code>Result.success(TValue value)</code> and <code>Result.failure(TFailure failure, [Object? exception, StackTrace? stackTrace ])</code>.</p>
<h2>
  
  
  A practical example
</h2>

<p>As an example, we will implement a complete authentication system, using this library and all existing concepts.</p>
<h2>
  
  
  Specification
</h2>

<ul>
<li>Authentication will be done exclusively through OAuth using Google or Apple (as everyone who has a cell phone must have a Google (Android) or Apple (iOS) account). Apple authentication should work on Android and vice versa (if the user had an iPhone at the time of first use and in the future decided to exchange the device for an Android or vice versa).</li>
<li>At the moment, the packages chosen for authentication are <code>sign_in_with_apple</code>, <code>google_sign_in</code> and <code>firebase_auth</code>, but we want these packages to be implemented as <em>plugins</em>, that is, if one day <code>sign_in_with_apple</code> is discontinued or another better package is released, we can make the change without having to change absolutely anything in the system.</li>
<li>Business rules must be reusable for other applications written in the future.</li>
<li>Authentication must be persisted in a local database, storing the date/time the user entered the application, as well as the data that was used (such as user ID and authentication method).</li>
<li>As authentication can take a long time, the UI must report each stage of it (waiting for OAuth provider, waiting for Firebase, waiting for database, etc.)</li>
</ul>
<h2>
  
  
  Project structure
</h2>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--hDCKFj9S--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://github.com/kodel-dynamics/simple_architecture/assets/379339/c6c83ee5-b585-4f5e-928d-883186fde411" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--hDCKFj9S--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://github.com/kodel-dynamics/simple_architecture/assets/379339/c6c83ee5-b585-4f5e-928d-883186fde411" alt="image" width="599" height="1541"></a></p>

<p>The <code>features</code> folder will contain all the features of our system (currently, we only have the <em>feature</em> <strong>AUTH</strong>).</p>

<p>Within each feature, we have:</p>

<ul>
<li>Domain - Everything that is in the application domain, that is, business rules, entities, etc. These parties have no knowledge of anything (other than contracts), do not generate I/O (i.e., do not create records in databases, do not call remote services, etc., all being implemented through contracts so that these I/O S are testable and do not generate <em>side-effects</em> (side effects - changing the physical state of an application by writing to a database, calling a web service, etc.). In this example, we have two entities: <code>AuthServiceCredential</code> which contains the result of an OAuth authentication (containing user data, access token and id token) and <code>Principal</code>, which represents an authenticated user. We have a notification <code>SignInAuthStageNotification</code> which will emit the current state of an authentication (i.e.: waiting for google, waiting for firebase, waiting for local database, etc.) Additionally, we have two initial <em>features</em>: <code>SignIn</code> and <code>SignOut</code>.</li>
<li>Infrastructure - All service contracts that must be implemented. Here we have contracts for the OAuth service (authentication via Google or Apple), the authentication service (Firebase Auth) and our repository to store information (database to record logins). There is no defined rule whether such contracts are interfaces (<code>abstract interface class</code>) or abstract classes (<code>abstract base class</code>). Interfaces just say that such methods or fields should be implemented. It only has the signature of such methods and absolutely no other code (not even constructors). There are cases, however, where certain features are standard for any implementation (for example, if we implemented authentication via email, it would be interesting to validate that email, so we could have a base authentication contract (<code>BaseAuthService</code>) that would implement this validation and then call an abstract method (no-code, signature-only method, just like interfaces).The D.R.Y. principle is more important than rules at this point.</li>
<li>Presentation - Here is everything related to Flutter: login-specific components (such as widgets that draw the Google or Apple logo to add to buttons), the authentication page itself, etc.</li>
<li>Settings: As the chosen packages have settings, we created a class that maintains these settings for access.</li>
<li>States: Finally, a state manager that maintains the current user or <code>null</code> if no user is authenticated.</li>
</ul>

<p>Additionally, we have a more generic feature for monitoring errors and performance, through pipeline behaviors.</p>

<p>In the <code>infrastructure</code> folder outside of <code>features</code> we have the actual implementation of the contracts we need (which are login implementation with <code>google_sign_in</code>, <code>sign_in_with_apple</code> and <code>firebase_auth</code>, in addition to our login registration repository with package <code>isar</code>).</p>

<p>Everything under <code>features</code> can be safely copied and pasted into other projects.</p>

<p>Everything under <code>infrastructure</code> can be copied and pasted, if the implementation is the same (i.e. if other projects also use Firebase Auth, etc.).</p>
<h2>
  
  
  Initialization
</h2>

<p>The app launch will look like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight dart"><code><span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">main</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="n">_registerSettings</span><span class="p">();</span>
  <span class="n">_registerServices</span><span class="p">();</span>
  <span class="n">_registerStates</span><span class="p">();</span>
  <span class="n">_registerHandlers</span><span class="p">();</span>
  <span class="n">_registerPipelines</span><span class="p">();</span>
  <span class="k">await</span> <span class="n">$initializeAsync</span><span class="p">();</span>
  <span class="n">runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">App</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_registerSettings</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">$settings</span><span class="o">.</span><span class="na">add</span><span class="p">(</span>
    <span class="n">AuthSettings</span><span class="p">(</span>
      <span class="nl">googleClientId:</span> <span class="n">DefaultFirebaseOptions</span><span class="o">.</span><span class="na">ios</span><span class="o">.</span><span class="na">androidClientId</span><span class="o">!</span><span class="p">,</span>
      <span class="nl">appleServiceId:</span> <span class="s">"TODO:"</span><span class="p">,</span>
      <span class="nl">appleRedirectUri:</span> <span class="kt">Uri</span><span class="o">.</span><span class="na">parse</span><span class="p">(</span><span class="s">"https://somewhere"</span><span class="p">),</span>
      <span class="nl">isGame:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_registerServices</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">$services</span><span class="o">.</span><span class="na">registerBootableSingleton</span><span class="p">(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="kd">const</span> <span class="n">FirebaseApp</span><span class="p">(),</span>
  <span class="p">);</span>

  <span class="n">$services</span><span class="o">.</span><span class="na">registerTransient</span><span class="p">&lt;</span><span class="n">IAuthService</span><span class="p">&gt;(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="kd">const</span> <span class="n">FirebaseAuthService</span><span class="p">(),</span>
  <span class="p">);</span>

  <span class="n">$services</span><span class="o">.</span><span class="na">registerTransient</span><span class="p">&lt;</span><span class="n">IAuthRepository</span><span class="p">&gt;(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="kd">const</span> <span class="n">IsarAuthRepository</span><span class="p">(),</span>
  <span class="p">);</span>

  <span class="n">$services</span><span class="o">.</span><span class="na">registerTransient</span><span class="p">&lt;</span><span class="n">IGoogleOAuthService</span><span class="p">&gt;(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">GoogleSignInService</span><span class="p">(</span><span class="nl">authSettings:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">AuthSettings</span><span class="p">&gt;()),</span>
  <span class="p">);</span>

  <span class="n">$services</span><span class="o">.</span><span class="na">registerTransient</span><span class="p">&lt;</span><span class="n">IAppleOAuthService</span><span class="p">&gt;(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">AppleSignInService</span><span class="p">(</span><span class="nl">authSettings:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">AuthSettings</span><span class="p">&gt;()),</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_registerStates</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">$states</span><span class="o">.</span><span class="na">registerState</span><span class="p">(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">AuthState</span><span class="p">(</span><span class="nl">authService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAuthService</span><span class="p">&gt;()),</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_registerHandlers</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">$mediator</span><span class="o">.</span><span class="na">registerRequestHandler</span><span class="p">(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">SignInRequestHandler</span><span class="p">(</span>
      <span class="nl">authService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAuthService</span><span class="p">&gt;(),</span>
      <span class="nl">googleOAuthService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IGoogleOAuthService</span><span class="p">&gt;(),</span>
      <span class="nl">appleOAuthService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAppleOAuthService</span><span class="p">&gt;(),</span>
      <span class="nl">authRepository:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAuthRepository</span><span class="p">&gt;(),</span>
    <span class="p">),</span>
  <span class="p">);</span>

  <span class="n">$mediator</span><span class="o">.</span><span class="na">registerRequestHandler</span><span class="p">(</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">SignOutRequestHandler</span><span class="p">(</span>
      <span class="nl">authService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAuthService</span><span class="p">&gt;(),</span>
      <span class="nl">googleOAuthService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IGoogleOAuthService</span><span class="p">&gt;(),</span>
      <span class="nl">appleOAuthService:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAppleOAuthService</span><span class="p">&gt;(),</span>
      <span class="nl">authRepository:</span> <span class="kd">get</span><span class="p">&lt;</span><span class="n">IAuthRepository</span><span class="p">&gt;(),</span>
    <span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_registerPipelines</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">$mediator</span><span class="o">.</span><span class="na">registerPipelineBehavior</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="kd">const</span> <span class="n">ErrorMonitoringPipelineBehavior</span><span class="p">(),</span>
    <span class="nl">registerAsTransient:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="n">$mediator</span><span class="o">.</span><span class="na">registerPipelineBehavior</span><span class="p">(</span>
    <span class="mi">1000</span><span class="p">,</span>
    <span class="p">(</span><span class="kd">get</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="kd">const</span> <span class="n">PerformancePipelineBehavior</span><span class="p">(),</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre>

</div>



<p>This code adds the authentication settings that are specific to each project (the GoogleClientId is obtained from the file generated by the Firebase CLI, the AppleServiceId is obtained from the settings generated on the website where we configure login via Apple (developer.apple.com) and the AppleRedirectUri Specifies the Uri that OAuth authentication uses to complete authentication.</p>

<p>Afterwards, the services are registered:</p>

<ul>
<li>There is a special service called <code>FirebaseApp</code> registered as <code>IBootable</code> that is only used to start Firebase (all Firebase packages need this initialization, so adding it as an <code>IBootable</code> causes it to be initialized at the beginning, before any other service is called).</li>
<li>We register our implementations linked to each necessary contract, that is, every time we need an <code>IAuthService</code>, a <code>FirebaseAuthService</code> will be returned. Note that some services may require other registered classes, for example, we must pass an <code>AuthSettings</code> to <code>GoogleSignInService</code>. By doing this via dependency injection, we guarantee that these values are defined in just one place.</li>
<li>We then register our state manager for authentication, <code>AuthState</code>
</li>
<li>For each <em>feature</em>, there is a message (<code>SignInRequest</code> and <code>SignOutRequest</code>). These messages are received and implemented by a <em>handler</em>, which is a class of pure business rules that will orchestrate (or apply a cake recipe) exactly how a <em>sign in</em> or a <em>sign out</em> is done. To do this, we register two <code>RequestHandlers</code>, one for each message.</li>
<li>Finally, we registered two pipeline behaviors to send all unhandled exceptions to Firebase Crashlytics and one to measure how long each <em>request</em> takes to complete.</li>
</ul>

<h2>
  
  
  Sign In
</h2>

<p>This is the complete code for the <em>feature</em> <em>sign in</em>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight dart"><code><span class="nd">@MappableEnum</span><span class="p">()</span>
<span class="kt">enum</span> <span class="n">SignInFailure</span> <span class="p">{</span>
  <span class="n">unknown</span><span class="p">,</span>
  <span class="n">cancelledByUser</span><span class="p">,</span>
  <span class="n">userDisabled</span><span class="p">,</span>
  <span class="n">networkRequestFailed</span><span class="p">,</span>
  <span class="n">notSupported</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">typedef</span> <span class="n">SignInResponse</span> <span class="o">=</span> <span class="n">Response</span><span class="p">&lt;</span><span class="n">Principal</span><span class="o">?</span><span class="p">,</span> <span class="n">SignInFailure</span><span class="p">&gt;;</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">SignInRequest</span> <span class="kd">implements</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">SignInResponse</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">SignInRequest</span><span class="p">(</span><span class="k">this</span><span class="o">.</span><span class="na">authProvider</span><span class="p">);</span>

  <span class="kd">final</span> <span class="n">AuthProvider</span> <span class="n">authProvider</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">SignInRequestHandler</span>
    <span class="kd">implements</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">SignInResponse</span><span class="p">,</span> <span class="n">SignInRequest</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">SignInRequestHandler</span><span class="p">({</span>
    <span class="kd">required</span> <span class="n">IAuthService</span> <span class="n">authService</span><span class="p">,</span>
    <span class="kd">required</span> <span class="n">IGoogleOAuthService</span> <span class="n">googleOAuthService</span><span class="p">,</span>
    <span class="kd">required</span> <span class="n">IAppleOAuthService</span> <span class="n">appleOAuthService</span><span class="p">,</span>
    <span class="kd">required</span> <span class="n">IAuthRepository</span> <span class="n">authRepository</span><span class="p">,</span>
  <span class="p">})</span>  <span class="o">:</span> <span class="n">_authService</span> <span class="o">=</span> <span class="n">authService</span><span class="p">,</span>
        <span class="n">_googleOAuthService</span> <span class="o">=</span> <span class="n">googleOAuthService</span><span class="p">,</span>
        <span class="n">_appleOAuthService</span> <span class="o">=</span> <span class="n">appleOAuthService</span><span class="p">,</span>
        <span class="n">_authRepository</span> <span class="o">=</span> <span class="n">authRepository</span><span class="p">;</span>

  <span class="kd">final</span> <span class="n">IAuthService</span> <span class="n">_authService</span><span class="p">;</span>
  <span class="kd">final</span> <span class="n">IGoogleOAuthService</span> <span class="n">_googleOAuthService</span><span class="p">;</span>
  <span class="kd">final</span> <span class="n">IAppleOAuthService</span> <span class="n">_appleOAuthService</span><span class="p">;</span>
  <span class="kd">final</span> <span class="n">IAuthRepository</span> <span class="n">_authRepository</span><span class="p">;</span>

  <span class="kd">static</span> <span class="kd">const</span> <span class="n">_logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">&lt;</span><span class="n">SignInRequestHandler</span><span class="p">&gt;();</span>

  <span class="nd">@override</span>
  <span class="n">Future</span><span class="p">&lt;</span><span class="n">SignInResponse</span><span class="p">&gt;</span> <span class="n">handle</span><span class="p">(</span><span class="n">SignInRequest</span> <span class="n">request</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="n">IOAuthService</span> <span class="n">oAuthService</span> <span class="o">=</span>
        <span class="n">request</span><span class="o">.</span><span class="na">authProvider</span> <span class="o">==</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">apple</span>
            <span class="o">?</span> <span class="n">_appleOAuthService</span>
            <span class="o">:</span> <span class="n">_googleOAuthService</span><span class="p">;</span>

    <span class="n">$mediator</span><span class="o">.</span><span class="na">publish</span><span class="p">(</span>
      <span class="n">SignInAuthStageNotification</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="na">authProvider</span> <span class="o">==</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">apple</span>
            <span class="o">?</span> <span class="n">AuthStage</span><span class="o">.</span><span class="na">signingInWithApple</span>
            <span class="o">:</span> <span class="n">AuthStage</span><span class="o">.</span><span class="na">signingInWithGoogle</span><span class="p">,</span>
      <span class="p">),</span>
    <span class="p">);</span>

    <span class="n">_logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Signing in with </span><span class="si">${request.authProvider}</span><span class="s">"</span><span class="p">);</span>

    <span class="kd">final</span> <span class="n">oAuthResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="n">oAuthService</span><span class="o">.</span><span class="na">signIn</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">oAuthResponse</span><span class="o">.</span><span class="na">isFailure</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">fromFailure</span><span class="p">(</span><span class="n">oAuthResponse</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">$mediator</span><span class="o">.</span><span class="na">publish</span><span class="p">(</span>
      <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">authorizing</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="n">_logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Authorizing"</span><span class="p">);</span>

    <span class="kd">final</span> <span class="n">authResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_authService</span><span class="o">.</span><span class="na">signIn</span><span class="p">(</span><span class="n">oAuthResponse</span><span class="o">.</span><span class="na">value</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">authResponse</span><span class="o">.</span><span class="na">isFailure</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">authResponse</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">$mediator</span><span class="o">.</span><span class="na">publish</span><span class="p">(</span>
      <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">registering</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="n">_logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">"Persisting"</span><span class="p">);</span>

    <span class="kd">final</span> <span class="n">repoResponse</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_authRepository</span><span class="o">.</span><span class="na">signIn</span><span class="p">(</span><span class="n">authResponse</span><span class="o">.</span><span class="na">value</span><span class="o">!</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">repoResponse</span><span class="o">.</span><span class="na">isFailure</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">repoResponse</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">$mediator</span><span class="o">.</span><span class="na">publish</span><span class="p">(</span>
      <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span><span class="o">.</span><span class="na">delayed</span><span class="p">(</span><span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="mi">500</span><span class="p">))</span>
        <span class="o">.</span><span class="na">then</span><span class="p">(</span>
          <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">$mediator</span><span class="o">.</span><span class="na">publish</span><span class="p">(</span>
            <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">),</span>
          <span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="na">ignore</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">repoResponse</span><span class="o">.</span><span class="na">isSuccess</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">$states</span><span class="o">.</span><span class="na">get</span><span class="p">&lt;</span><span class="n">AuthState</span><span class="p">&gt;()</span><span class="o">.</span><span class="na">change</span><span class="p">(</span><span class="n">repoResponse</span><span class="o">.</span><span class="na">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">repoResponse</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p>First, we implement equality by value for events, requests, entities, etc. using the great <code>dart_mappable</code> library. This is necessary to avoid rebuilds in our interface or triggering services when nothing has changed. Dart makes a comparison by reference, that is, one object is only equal to another if they point to the same object in memory. When we use immutability, we always generate a copy of an object, with possible changes. This copy, for Dart, is always different from the first (even if the values are the same). <code>dart_mappable</code> then implements value comparison (i.e., compares each field within a class to verify that they represent exactly the same entity). We use <code>dart_mappable</code> because it doesn't influence what you can do with your class (<code>freezed</code> for example prevents or hinders certain features like inheritance, generics, methods, etc.) and it also implements several other useful features, like <code>copyWith</code> and serialization (<code>toMap</code> and <code>toJson</code>).</p>

<p>Using the principles described in Vertical Slice Architecture (<a href="https://www.jimmybogard.com/vertical-slice-architecture/">https://www.jimmybogard.com/vertical-slice-architecture/</a>), we try to keep everything related to a <em>feature</em> within the same file (only separating implementations that cannot be copied and glued securely to other projects or entities that are generally used without needing everything else). So our file contains:</p>

<p>1) A <code>SignInFailure</code> enum that represents the possible errors that can occur during a sign in.<br>
2) A <code>Request</code> that represents the desire to sign in (the UI will trigger this Request, informing whether you want to authenticate via Google or Apple, and everything will be done "automatically").<br>
3) A handler for this request, which will implement the sign in logic per se. This logic emits events of type <code>SignInAuthStageNotification</code> so that the UI can show what is happening and then tries to authenticate with the specified provider (Google or Apple), which will emit an error or a credential (containing user data and access tokens ). If successful, this will be sent to Firebase Auth to generate a truly authenticated user. Finally, we send this almost ready-made user to the repository, so that we can write information about the user and the login made to the database.</p>

<p>Note that some things are still missing, such as reporting this login to Firebase Analytics, correcting the fact that signing in with Apple only sends the user name on the first authentication (our logic must consider this provider limitation and adjust the authenticated user accordingly , as a business rule).</p>

<p>But, basically, we have here all the requirements that we defined, such as reusability, granularity of <em>features</em>, testability, etc. and we can add or remove features very simply without even having to change the parts that are already ready. For example, to implement login logging in Firebase Analytics, we can simply write an <code>IBootable</code> service that registers itself as an <code>listener</code> of the authentication state (<code>AuthState</code>) and, when it occurs, does what it needs to do (which is basically calling a method saying that the user with ID <em>X</em> has authenticated). We can, additionally, emit a specific event at the end of the authentication process (such as <code>UserHasSignedIn(Principal)</code>), so any module that may be written in the future can listen to this event and do what it wants, without the rest of the application have this knowledge.</p>

<p>The possibilities and freedoms of implementation are open.</p>
<h3>
  
  
  Implementations
</h3>

<p>Some extra details on implementations or usage:</p>

<p><code>google_sign_in_service</code><br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight dart"><code><span class="kd">final</span> <span class="kd">class</span> <span class="nc">GoogleSignInService</span> <span class="kd">implements</span> <span class="n">IGoogleOAuthService</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">GoogleSignInService</span><span class="p">({</span>
    <span class="kd">required</span> <span class="n">AuthSettings</span> <span class="n">authSettings</span><span class="p">,</span>
  <span class="p">})</span> <span class="o">:</span> <span class="n">_authSettings</span> <span class="o">=</span> <span class="n">authSettings</span><span class="p">;</span>

  <span class="kd">final</span> <span class="n">AuthSettings</span> <span class="n">_authSettings</span><span class="p">;</span>

  <span class="kd">static</span> <span class="n">GoogleSignIn</span><span class="o">?</span> <span class="n">__googleSignIn</span><span class="p">;</span>

  <span class="n">GoogleSignIn</span> <span class="kd">get</span> <span class="n">_googleSignIn</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">__googleSignIn</span> <span class="o">??=</span> <span class="n">GoogleSignIn</span><span class="p">(</span>
        <span class="nl">clientId:</span> <span class="n">kIsWeb</span> <span class="o">||</span> <span class="n">Platform</span><span class="o">.</span><span class="na">isAndroid</span> <span class="o">==</span> <span class="kc">false</span>
            <span class="o">?</span> <span class="n">_authSettings</span><span class="o">.</span><span class="na">googleClientId</span>
            <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nl">hostedDomain:</span> <span class="n">kIsWeb</span> <span class="o">||</span> <span class="n">Platform</span><span class="o">.</span><span class="na">isAndroid</span> <span class="o">==</span> <span class="kc">false</span>
            <span class="o">?</span> <span class="n">_authSettings</span><span class="o">.</span><span class="na">googleClientUrl</span>
            <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nl">scopes:</span> <span class="p">[</span><span class="s">"email"</span><span class="p">],</span>
        <span class="nl">signInOption:</span>
            <span class="n">_authSettings</span><span class="o">.</span><span class="na">isGame</span> <span class="o">?</span> <span class="n">SignInOption</span><span class="o">.</span><span class="na">games</span> <span class="o">:</span> <span class="n">SignInOption</span><span class="o">.</span><span class="na">standard</span><span class="p">,</span>
      <span class="p">);</span>

  <span class="nd">@override</span>
  <span class="n">Future</span><span class="p">&lt;</span><span class="n">AuthServiceCredentialResponse</span><span class="p">&gt;</span> <span class="n">signIn</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">final</span> <span class="n">account</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_googleSignIn</span><span class="o">.</span><span class="na">signIn</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">account</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">const</span> <span class="n">AuthServiceCredentialResponse</span><span class="o">.</span><span class="na">failure</span><span class="p">(</span>
          <span class="n">SignInFailure</span><span class="o">.</span><span class="na">cancelledByUser</span><span class="p">,</span>
        <span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">final</span> <span class="n">auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">account</span><span class="o">.</span><span class="na">authentication</span><span class="p">;</span>

      <span class="k">return</span> <span class="n">AuthServiceCredentialResponse</span><span class="o">.</span><span class="na">success</span><span class="p">(</span>
        <span class="n">AuthServiceCredential</span><span class="p">(</span>
          <span class="nl">accessToken:</span> <span class="n">auth</span><span class="o">.</span><span class="na">accessToken</span> <span class="o">??</span> <span class="s">""</span><span class="p">,</span>
          <span class="nl">idToken:</span> <span class="n">auth</span><span class="o">.</span><span class="na">idToken</span> <span class="o">??</span> <span class="s">""</span><span class="p">,</span>
          <span class="nl">userName:</span> <span class="n">account</span><span class="o">.</span><span class="na">displayName</span><span class="p">,</span>
          <span class="nl">userEmail:</span> <span class="n">account</span><span class="o">.</span><span class="na">email</span><span class="p">,</span>
          <span class="nl">userAvatarUrl:</span> <span class="n">account</span><span class="o">.</span><span class="na">photoUrl</span><span class="p">,</span>
          <span class="nl">authProvider:</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">google</span><span class="p">,</span>
        <span class="p">),</span>
      <span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">stackTrace</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">AuthServiceCredentialResponse</span><span class="o">.</span><span class="na">failure</span><span class="p">(</span>
        <span class="n">SignInFailure</span><span class="o">.</span><span class="na">unknown</span><span class="p">,</span>
        <span class="n">ex</span><span class="p">,</span>
        <span class="n">stackTrace</span><span class="p">,</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nd">@override</span>
  <span class="n">Future</span><span class="p">&lt;</span><span class="n">SignOutResponse</span><span class="p">&gt;</span> <span class="n">signOut</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="n">_googleSignIn</span><span class="o">.</span><span class="na">isSignedIn</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">await</span> <span class="n">_googleSignIn</span><span class="o">.</span><span class="na">signOut</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kd">const</span> <span class="n">SignOutResponse</span><span class="o">.</span><span class="na">success</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p><code>firebase_auth_service.dart</code>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight dart"><code><span class="kd">final</span> <span class="kd">class</span> <span class="nc">FirebaseAuthService</span> <span class="kd">implements</span> <span class="n">IAuthService</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">FirebaseAuthService</span><span class="p">();</span>

  <span class="kd">static</span> <span class="kd">const</span> <span class="n">_logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">&lt;</span><span class="n">FirebaseAuthService</span><span class="p">&gt;();</span>

  <span class="nd">@override</span>
  <span class="n">Future</span><span class="p">&lt;</span><span class="n">SignInResponse</span><span class="p">&gt;</span> <span class="n">getCurrentPrincipal</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="n">cu</span> <span class="o">=</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">currentUser</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cu</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_logger</span><span class="o">.</span><span class="na">debug</span><span class="p">(()</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"No user authenticated"</span><span class="p">);</span>
      <span class="k">return</span> <span class="kd">const</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">success</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">AuthProvider</span><span class="o">?</span> <span class="n">authProvider</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">data</span> <span class="k">in</span> <span class="n">cu</span><span class="o">.</span><span class="na">providerData</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="na">providerId</span> <span class="o">==</span> <span class="n">AppleAuthProvider</span><span class="o">.</span><span class="na">PROVIDER_ID</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">authProvider</span> <span class="o">=</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">apple</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="na">providerId</span> <span class="o">==</span> <span class="n">GoogleAuthProvider</span><span class="o">.</span><span class="na">PROVIDER_ID</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">authProvider</span> <span class="o">=</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">google</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">authProvider</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s">"AuthProvider should have a value"</span><span class="p">);</span>

    <span class="kd">final</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">Principal</span><span class="o">.</span><span class="na">normalize</span><span class="p">(</span>
      <span class="nl">id:</span> <span class="n">cu</span><span class="o">.</span><span class="na">uid</span><span class="p">,</span>
      <span class="nl">name:</span> <span class="n">cu</span><span class="o">.</span><span class="na">displayName</span><span class="p">,</span>
      <span class="nl">avatarUrl:</span> <span class="n">cu</span><span class="o">.</span><span class="na">photoURL</span><span class="p">,</span>
      <span class="nl">email:</span> <span class="n">cu</span><span class="o">.</span><span class="na">email</span><span class="p">,</span>
      <span class="nl">authProvider:</span> <span class="n">authProvider</span><span class="o">!</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="n">_logger</span><span class="o">.</span><span class="na">debug</span><span class="p">(()</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"Authenticated user: </span><span class="si">${principal}</span><span class="s">"</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">success</span><span class="p">(</span><span class="n">principal</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@override</span>
  <span class="n">Future</span><span class="p">&lt;</span><span class="n">SignInResponse</span><span class="p">&gt;</span> <span class="n">signIn</span><span class="p">(</span>
    <span class="n">AuthServiceCredential</span> <span class="n">authServiceCredential</span><span class="p">,</span>
  <span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">final</span> <span class="n">credential</span> <span class="o">=</span>
          <span class="n">authServiceCredential</span><span class="o">.</span><span class="na">authProvider</span> <span class="o">==</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">apple</span>
              <span class="o">?</span> <span class="n">AppleAuthProvider</span><span class="o">.</span><span class="na">credential</span><span class="p">(</span>
                  <span class="n">authServiceCredential</span><span class="o">.</span><span class="na">accessToken</span><span class="p">,</span>
                <span class="p">)</span>
              <span class="o">:</span> <span class="n">GoogleAuthProvider</span><span class="o">.</span><span class="na">credential</span><span class="p">(</span>
                  <span class="nl">accessToken:</span> <span class="n">authServiceCredential</span><span class="o">.</span><span class="na">accessToken</span><span class="p">,</span>
                  <span class="nl">idToken:</span> <span class="n">authServiceCredential</span><span class="o">.</span><span class="na">idToken</span><span class="p">,</span>
                <span class="p">);</span>

      <span class="kd">final</span> <span class="n">auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">signInWithCredential</span><span class="p">(</span><span class="n">credential</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="na">user</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_logger</span><span class="o">.</span><span class="na">error</span><span class="p">(</span>
          <span class="s">"auth.user should not be null after signInWithCredential!"</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="kd">const</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">failure</span><span class="p">(</span><span class="n">SignInFailure</span><span class="o">.</span><span class="na">cancelledByUser</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="n">getCurrentPrincipal</span><span class="p">();</span>
    <span class="p">}</span> <span class="kd">on</span> <span class="n">FirebaseAuthException</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">stackTrace</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="na">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">"user-disabled"</span><span class="o">:</span>
          <span class="k">return</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">failure</span><span class="p">(</span>
            <span class="n">SignInFailure</span><span class="o">.</span><span class="na">userDisabled</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">,</span>
            <span class="n">stackTrace</span><span class="p">,</span>
          <span class="p">);</span>
        <span class="k">case</span> <span class="s">"network-request-failed"</span><span class="o">:</span>
          <span class="k">return</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">failure</span><span class="p">(</span>
            <span class="n">SignInFailure</span><span class="o">.</span><span class="na">networkRequestFailed</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">,</span>
            <span class="n">stackTrace</span><span class="p">,</span>
          <span class="p">);</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">return</span> <span class="n">SignInResponse</span><span class="o">.</span><span class="na">failure</span><span class="p">(</span>
            <span class="n">SignInFailure</span><span class="o">.</span><span class="na">unknown</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">,</span>
            <span class="n">stackTrace</span><span class="p">,</span>
          <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nd">@override</span>
  <span class="n">Future</span><span class="p">&lt;</span><span class="n">SignOutResponse</span><span class="p">&gt;</span> <span class="n">signOut</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">currentUser</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">await</span> <span class="n">FirebaseAuth</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">signOut</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kd">const</span> <span class="n">SignOutResponse</span><span class="o">.</span><span class="na">success</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



<p><code>login_page</code>:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight dart"><code><span class="kd">class</span> <span class="nc">LoginPage</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">LoginPage</span><span class="p">({</span><span class="k">super</span><span class="o">.</span><span class="na">key</span><span class="p">});</span>

  <span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">_signIn</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">AuthProvider</span> <span class="n">authProvider</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">$mediator</span><span class="o">.</span><span class="na">send</span><span class="p">(</span><span class="n">SignInRequest</span><span class="p">(</span><span class="n">authProvider</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="na">isSuccess</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="na">failure</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">SignInFailure</span><span class="o">.</span><span class="na">cancelledByUser</span><span class="o">:</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">SignInFailure</span><span class="o">.</span><span class="na">networkRequestFailed</span><span class="o">:</span>
        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="na">showOKDialog</span><span class="p">(</span>
          <span class="nl">title:</span> <span class="s">"No internet connection"</span><span class="p">,</span>
          <span class="nl">message:</span> <span class="s">"There were a failure while trying to reach the "</span>
              <span class="s">"authentication service.</span><span class="se">\n\n</span><span class="s">Please, check your internet connection."</span><span class="p">,</span>
        <span class="p">);</span>
      <span class="k">case</span> <span class="n">SignInFailure</span><span class="o">.</span><span class="na">userDisabled</span><span class="o">:</span>
        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="na">showOKDialog</span><span class="p">(</span>
          <span class="nl">title:</span> <span class="s">"User is disabled"</span><span class="p">,</span>
          <span class="nl">message:</span> <span class="s">"Your user is disabled, please, contact support."</span><span class="p">,</span>
        <span class="p">);</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="na">showOKDialog</span><span class="p">(</span>
          <span class="nl">title:</span> <span class="s">"Oops"</span><span class="p">,</span>
          <span class="nl">message:</span> <span class="s">"An unknown error has ocurred!</span><span class="se">\n\n</span><span class="s">"</span>
              <span class="s">"(Details: </span><span class="si">${response.exception}</span><span class="s">)"</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="n">theme</span> <span class="o">=</span> <span class="n">Theme</span><span class="o">.</span><span class="na">of</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">StreamBuilder</span><span class="p">(</span>
      <span class="nl">stream:</span> <span class="n">$mediator</span><span class="o">.</span><span class="na">getChannel</span><span class="p">&lt;</span><span class="n">SignInAuthStageNotification</span><span class="p">&gt;(),</span>
      <span class="nl">initialData:</span> <span class="kd">const</span> <span class="n">SignInAuthStageNotification</span><span class="p">(</span><span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">),</span>
      <span class="nl">builder:</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">currentAuthStage</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="na">data</span><span class="o">?.</span><span class="na">stage</span> <span class="o">??</span> <span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">;</span>

        <span class="kd">final</span> <span class="n">authMessage</span> <span class="o">=</span> <span class="k">switch</span> <span class="p">(</span><span class="n">currentAuthStage</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"Sign in with"</span><span class="p">,</span>
          <span class="n">AuthStage</span><span class="o">.</span><span class="na">signingInWithApple</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"Awaiting Apple..."</span><span class="p">,</span>
          <span class="n">AuthStage</span><span class="o">.</span><span class="na">signingInWithGoogle</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"Awaiting Google..."</span><span class="p">,</span>
          <span class="n">AuthStage</span><span class="o">.</span><span class="na">authorizing</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"Authorizing..."</span><span class="p">,</span>
          <span class="n">AuthStage</span><span class="o">.</span><span class="na">registering</span> <span class="o">=</span><span class="p">&gt;</span> <span class="s">"Registering..."</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="kd">final</span> <span class="n">isBusy</span> <span class="o">=</span> <span class="n">currentAuthStage</span> <span class="o">!=</span> <span class="n">AuthStage</span><span class="o">.</span><span class="na">idle</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
          <span class="nl">body:</span> <span class="n">SafeArea</span><span class="p">(</span>
            <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
              <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
                <span class="nl">mainAxisSize:</span> <span class="n">MainAxisSize</span><span class="o">.</span><span class="na">max</span><span class="p">,</span>
                <span class="nl">crossAxisAlignment:</span> <span class="n">CrossAxisAlignment</span><span class="o">.</span><span class="na">center</span><span class="p">,</span>
                <span class="nl">children:</span> <span class="p">[</span>
                  <span class="kd">const</span> <span class="n">Spacer</span><span class="p">(),</span>
                  <span class="kd">const</span> <span class="n">AppLogo</span><span class="p">(</span><span class="nl">dimension:</span> <span class="mi">200</span><span class="p">),</span>
                  <span class="kd">const</span> <span class="n">SizedBox</span><span class="o">.</span><span class="na">square</span><span class="p">(</span><span class="nl">dimension:</span> <span class="mi">16</span><span class="p">),</span>
                  <span class="n">Text</span><span class="p">(</span>
                    <span class="s">"App Name"</span><span class="p">,</span>
                    <span class="nl">style:</span> <span class="n">theme</span><span class="o">.</span><span class="na">textTheme</span><span class="o">.</span><span class="na">headlineMedium</span><span class="p">,</span>
                  <span class="p">),</span>
                  <span class="kd">const</span> <span class="n">Spacer</span><span class="p">(),</span>
                  <span class="n">Text</span><span class="p">(</span>
                    <span class="n">authMessage</span><span class="p">,</span>
                    <span class="nl">style:</span> <span class="n">theme</span><span class="o">.</span><span class="na">textTheme</span><span class="o">.</span><span class="na">labelMedium</span><span class="p">,</span>
                  <span class="p">),</span>
                  <span class="kd">const</span> <span class="n">SizedBox</span><span class="o">.</span><span class="na">square</span><span class="p">(</span><span class="nl">dimension:</span> <span class="mi">8</span><span class="p">),</span>
                  <span class="n">isBusy</span>
                      <span class="o">?</span> <span class="kd">const</span> <span class="n">Center</span><span class="p">(</span>
                          <span class="nl">child:</span> <span class="n">SizedBox</span><span class="o">.</span><span class="na">square</span><span class="p">(</span>
                            <span class="nl">dimension:</span> <span class="mi">48</span><span class="p">,</span>
                            <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
                              <span class="nl">child:</span> <span class="n">CircularProgressIndicator</span><span class="o">.</span><span class="na">adaptive</span><span class="p">(),</span>
                            <span class="p">),</span>
                          <span class="p">),</span>
                        <span class="p">)</span>
                      <span class="o">:</span> <span class="n">Row</span><span class="p">(</span>
                          <span class="nl">mainAxisSize:</span> <span class="n">MainAxisSize</span><span class="o">.</span><span class="na">min</span><span class="p">,</span>
                          <span class="nl">crossAxisAlignment:</span> <span class="n">CrossAxisAlignment</span><span class="o">.</span><span class="na">center</span><span class="p">,</span>
                          <span class="nl">children:</span> <span class="p">[</span>
                            <span class="n">_AuthProviderButton</span><span class="p">(</span>
                              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=</span><span class="p">&gt;</span>
                                  <span class="n">_signIn</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">google</span><span class="p">),</span>
                              <span class="nl">icon:</span> <span class="kd">const</span> <span class="n">GoogleLogo</span><span class="p">(</span><span class="nl">dimension:</span> <span class="mi">16</span><span class="p">),</span>
                            <span class="p">),</span>
                            <span class="n">Transform</span><span class="o">.</span><span class="na">translate</span><span class="p">(</span>
                              <span class="nl">offset:</span> <span class="kd">const</span> <span class="n">Offset</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                              <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span>
                                <span class="s">" or "</span><span class="p">,</span>
                                <span class="nl">style:</span> <span class="n">theme</span><span class="o">.</span><span class="na">textTheme</span><span class="o">.</span><span class="na">labelMedium</span><span class="p">,</span>
                              <span class="p">),</span>
                            <span class="p">),</span>
                            <span class="n">_AuthProviderButton</span><span class="p">(</span>
                              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=</span><span class="p">&gt;</span>
                                  <span class="n">_signIn</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">AuthProvider</span><span class="o">.</span><span class="na">apple</span><span class="p">),</span>
                              <span class="nl">icon:</span> <span class="kd">const</span> <span class="n">AppleLogo</span><span class="p">(</span>
                                <span class="nl">dimension:</span> <span class="mi">16</span><span class="p">,</span>
                                <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">black</span><span class="p">,</span>
                              <span class="p">),</span>
                            <span class="p">),</span>
                          <span class="p">],</span>
                        <span class="p">),</span>
                  <span class="kd">const</span> <span class="n">Spacer</span><span class="p">(),</span>
                  <span class="n">Padding</span><span class="p">(</span>
                    <span class="nl">padding:</span> <span class="kd">const</span> <span class="n">EdgeInsets</span><span class="o">.</span><span class="na">symmetric</span><span class="p">(</span><span class="nl">horizontal:</span> <span class="mi">16</span><span class="p">),</span>
                    <span class="nl">child:</span> <span class="n">Row</span><span class="p">(</span>
                      <span class="nl">mainAxisSize:</span> <span class="n">MainAxisSize</span><span class="o">.</span><span class="na">max</span><span class="p">,</span>
                      <span class="nl">mainAxisAlignment:</span> <span class="n">MainAxisAlignment</span><span class="o">.</span><span class="na">spaceBetween</span><span class="p">,</span>
                      <span class="nl">children:</span> <span class="p">[</span>
                        <span class="n">TextButton</span><span class="p">(</span>
                          <span class="nl">onPressed:</span> <span class="n">isBusy</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">()</span> <span class="p">{},</span>
                          <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span>
                            <span class="s">"PRIVACY POLICY"</span><span class="p">,</span>
                            <span class="nl">style:</span> <span class="n">theme</span><span class="o">.</span><span class="na">textTheme</span><span class="o">.</span><span class="na">labelSmall</span><span class="p">,</span>
                          <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">TextButton</span><span class="p">(</span>
                          <span class="nl">onPressed:</span> <span class="n">isBusy</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">()</span> <span class="p">{},</span>
                          <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span>
                            <span class="s">"ABOUT"</span><span class="p">,</span>
                            <span class="nl">style:</span> <span class="n">theme</span><span class="o">.</span><span class="na">textTheme</span><span class="o">.</span><span class="na">labelSmall</span><span class="p">,</span>
                          <span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">TextButton</span><span class="p">(</span>
                          <span class="nl">onPressed:</span> <span class="n">isBusy</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">()</span> <span class="p">{},</span>
                          <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span>
                            <span class="s">"TERMS OF USE"</span><span class="p">,</span>
                            <span class="nl">style:</span> <span class="n">theme</span><span class="o">.</span><span class="na">textTheme</span><span class="o">.</span><span class="na">labelSmall</span><span class="p">,</span>
                          <span class="p">),</span>
                        <span class="p">)</span>
                      <span class="p">],</span>
                    <span class="p">),</span>
                  <span class="p">),</span>
                <span class="p">],</span>
              <span class="p">),</span>
            <span class="p">),</span>
          <span class="p">),</span>
        <span class="p">);</span>
      <span class="p">},</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">_AuthProviderButton</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">_AuthProviderButton</span><span class="p">({</span>
    <span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">onPressed</span><span class="p">,</span>
    <span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">icon</span><span class="p">,</span>
  <span class="p">});</span>

  <span class="kd">final</span> <span class="kt">void</span> <span class="kt">Function</span><span class="p">()</span> <span class="n">onPressed</span><span class="p">;</span>
  <span class="kd">final</span> <span class="n">Widget</span> <span class="n">icon</span><span class="p">;</span>

  <span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">IconButton</span><span class="p">(</span>
      <span class="nl">onPressed:</span> <span class="n">onPressed</span><span class="p">,</span>
      <span class="nl">isSelected:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nl">icon:</span> <span class="n">Container</span><span class="p">(</span>
        <span class="nl">width:</span> <span class="mi">44</span><span class="p">,</span>
        <span class="nl">height:</span> <span class="mi">44</span><span class="p">,</span>
        <span class="nl">decoration:</span> <span class="n">BoxDecoration</span><span class="p">(</span>
          <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">white</span><span class="p">,</span>
          <span class="nl">borderRadius:</span> <span class="n">BorderRadius</span><span class="o">.</span><span class="na">circular</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
          <span class="nl">boxShadow:</span> <span class="kd">const</span> <span class="p">[</span>
            <span class="n">BoxShadow</span><span class="p">(</span>
              <span class="nl">color:</span> <span class="n">Colors</span><span class="o">.</span><span class="na">black26</span><span class="p">,</span>
              <span class="nl">blurRadius:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
          <span class="p">],</span>
        <span class="p">),</span>
        <span class="nl">child:</span> <span class="n">icon</span><span class="p">,</span>
      <span class="p">),</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

</div>



 </details> 
 <hr /> 

 #### - [What's your favorite scary movie? üò±](https://dev.to/devteam/whats-your-favorite-scary-movie-35lj) 
 <details><summary>Article</summary> <p>We're about midway through October now and Halloween is just around the corner! üéÉ</p>

<p>If you're like me, then you've already indulged in several horror flicks and are having a damn good, spine-tingling time. Every bump in the night puts me on alert, and I wouldn't have it any other way... it's too much fun being freaked out. üëª</p>

<p><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--3WpzOB0V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/74cfk0oua1i8ecgccmkb.gif" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--3WpzOB0V--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/74cfk0oua1i8ecgccmkb.gif" alt="A cute cartoon ghost eating popcorn and looking freaked out while apparently watching a horror film" width="480" height="480"></a></p>

<p>I like it all. From aliens to zombies, classics to modern-day, cult to mainstream, comedy horror hybrids to straight-up scary flicks... if it's horror, you can count me in.</p>

<p>That being said, I'm running through my list really quickly and need some good suggestions to keep me going... so <strong>what's your favorite scary movie?</strong></p>

<p>Comment below before I come find you and eat your brains! üß†üßü</p>

 </details> 
 <hr /> 

 #### - [Dev.to articles migration to markdown files](https://dev.to/idiglove/devto-articles-migration-to-markdown-files-4iop) 
 <details><summary>Article</summary> <p>As part of my migration to TinaCMS, I also want to migrate all my dev.to articles to my new blog website. My primary goal is to consolidate all my blog posts from various platforms in my personal website.</p>

<p>Just create a new npm project, and add these dependencies:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>"devDependencies": {
    "@types/node": "^20.8.2",
    "typescript": "^5.2.2"
  },
  "dependencies": {
    "axios": "^1.5.1",
    "ts-node": "^10.9.1"
  }
</code></pre>

</div>



<p>Another requirement is getting your API key from dev.to. Save it in a safe storage and we will use it in our code. You can store it in a .env variable, but we will hard-code it for simplicity.</p>

<p>NOTE: To follow this tutorial, try to read everything first. Each block of code in the following lines can be added in one js file.</p>

<h2>
  
  
  Fetching dev.to articles, looping through each and converting to a markdown file
</h2>

<p>My starting entry point function looks like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="k">async</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// fetch your own dev.to published articles</span>
    <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://dev.to/api/articles/me/published</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">api-key</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CSQVPaBYr6aEv8LR5os4m14K</span><span class="dl">"</span> <span class="p">},</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">files</span><span class="p">:</span> <span class="nx">Article</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="cm">/**
     * loop through each article which we are calling `file`
     * then convert each one to a valid markdown file
     */</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">convert</span><span class="p">(</span>
        <span class="c1">// the first argument is the whole body of the markdown</span>
        <span class="c1">// we are concatenating the frontmatter + markdown body</span>
        <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">createFrontmatter</span><span class="p">(</span><span class="nx">file</span><span class="p">)}${</span><span class="nx">file</span><span class="p">.</span><span class="nx">body_markdown</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
        <span class="s2">`</span><span class="p">${</span><span class="nx">file</span><span class="p">.</span><span class="nx">slug</span><span class="p">}</span><span class="s2">.md`</span>
      <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

</code></pre>

</div>



<p>The <code>convert</code> function can be found below this article. It receives 2 parameters: the markdown data which is a string, and the fileName which is also a string. The markdown data has the <code>frontmatter</code> which is discussed right below, and also the body data which is preceded by <code>---</code> characters.</p>

<h2>
  
  
  Create frontmatter
</h2>

<p>Frontmatter is the metadata of a markdown, it can include any data. Also, since each value (like a title) can have a <code>:</code> character, we will add the value on the next line after the key. For example: <code>${key}: &gt; \n ${data[key]}\n;</code></p>

<p>Here is the code:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="nx">createFrontmatter</span><span class="p">(</span>
    <span class="nx">data</span><span class="p">:</span> <span class="nx">Article</span><span class="p">,</span>
    <span class="nx">excluded</span><span class="p">:</span> <span class="nx">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">body_markdown</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">]</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// a frontmatter starts and ends with `---`</span>
    <span class="c1">// this is the start</span>
    <span class="kd">let</span> <span class="nx">frontmatter</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">---</span><span class="se">\n</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">// this is the middle of the frontmatter</span>
    <span class="c1">// which looks like key: &gt; \n value</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">excluded</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">frontmatter</span> <span class="o">+=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">: &gt; \n </span><span class="p">${</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]}</span><span class="s2">\n`</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// this is the end of the frontmatter</span>
    <span class="nx">frontmatter</span> <span class="o">+=</span> <span class="s2">`---\n`</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">frontmatter</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre>

</div>



<p>Dev.to provides a lot of kinds of data for us, but we will exclude <code>body_markdown</code> and <code>user</code> data.</p>

<h2>
  
  
  Writing the strings to markdown file
</h2>



<div class="highlight js-code-highlight">
<pre class="highlight javascript"><code><span class="nx">convert</span><span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s2">`md/</span><span class="p">${</span><span class="nx">fileName</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Write to file has an error</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Write to file was successful</span><span class="dl">"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre>

</div>



<p>Also, create an Article TS type:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight typescript"><code><span class="kd">type</span> <span class="nx">Article</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">description</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">published_at</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">path</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">slug</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">body_markdown</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>

</div>



<p>After you have run this script, you can manually move the markdown files to your Tina posts folder.</p>

<p>Let me know if you have any questions and clarifications,<br>
Cheers<br>
FM</p>

 </details> 
 <hr /> 
<!-- BLOG-POST-LIST:END -->
</table>
</details>


<!-- TODO
Change the 3stats boxes around, possibly two on top and one on bottom
Fix RSSfeed
Fix Spotify Playlists
Fix Socials [Portfolio, Discord, Linkedin]
In the future, add Public Repositories of Selected Projects
-->
